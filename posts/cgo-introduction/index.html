<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>認識 Cgo：Go 與 C 語言的橋樑 - Yuan のノート</title><meta name=description content="心之所至，隨意亂書"><meta name=keywords content="golang,embedded,linux,backend,programming"><meta name=author content="Yuan"><meta property="og:title" content="認識 Cgo：Go 與 C 語言的橋樑 - Yuan のノート"><meta property="og:description" content="心之所至，隨意亂書"><meta property="og:type" content="article"><meta property="og:url" content="https://e61983.github.io/posts/cgo-introduction/"><link rel=icon type=image/svg+xml href=/favicon.svg><link rel=icon type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/favicon.svg><meta name=theme-color content="#0d1117"><link rel=stylesheet href=https://e61983.github.io/yuan/css/main.min.css><link rel=stylesheet href=https://e61983.github.io/yuan/css/chroma.min.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel=stylesheet></head><body class=theme-dark><div class=layout><header class=header><div class=container><div class=header-content><div class=header-brand><a href=https://e61983.github.io/ class=brand-link><span class=brand-text>Yuan のノート</span></a><p class=brand-subtitle>心之所至，隨意亂書</p></div><nav class=nav><ul class=nav-list><li class=nav-item><a href=/ class=nav-link>首頁</a></li><li class=nav-item><a href=/posts/ class=nav-link>文章</a></li><li class=nav-item><a href=/categories/ class=nav-link>分類</a></li><li class=nav-item><a href=/tags/ class=nav-link>標籤</a></li><li class=nav-item><a href=/archive/ class=nav-link>歸檔</a></li></ul></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span class=hamburger></span>
<span class=hamburger></span>
<span class=hamburger></span></button></div></div></header><main class=main><div class=container><div class=post-layout><article class=post><header class=post-header><h1 class=post-title>認識 Cgo：Go 與 C 語言的橋樑</h1><div class=post-meta><time class=post-date datetime=2025-09-02T22:22:33+08:00>2025年09月02日
</time><span class=reading-time>2 分鐘閱讀</span>
<span class=word-count>384 字</span></div><div class=post-tags><a href=/tags/gcc class=tag>gcc</a>
<a href=/tags/go class=tag>go</a>
<a href=/tags/cgo class=tag>cgo</a></div><div class=post-categories><a href=/categories/note class=category>note</a></div></header><div class=mobile-toc-toggle><button class=toc-toggle-btn aria-label=顯示/隱藏目錄>
<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h14v-2H3v2zm16 0h2v-2h-2v2zm0-10v2h2V7h-2zm0 6h2v-2h-2v2z"/></svg>
目錄</button><nav class=mobile-toc><h3 class=toc-title>目錄</h3><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#cgo-是什麼>cgo 是什麼？</a></li><li><a href=#基本使用方式>基本使用方式</a></li><li><a href=#c-型別的取用>C 型別的取用</a><ul><li><a href=#go-與-c-的字串轉換>Go 與 C 的字串轉換</a></li></ul></li><li><a href=#go-與-c-型別對應表>Go 與 C 型別對應表</a></li><li><a href=#定義編譯器旗標cflagsldflags>定義編譯器旗標（CFLAGS、LDFLAGS）</a></li><li><a href=#境變數與安全限制技巧>境變數與安全限制技巧</a></li><li><a href=#常見錯誤與除錯技巧>常見錯誤與除錯技巧</a></li><li><a href=#小結>小結</a></li></ul></nav></nav></div><div class=post-content><h2 id=前言>前言</h2><p>在撰寫 Go 程式的過程中，有時候我們會遇到這樣的情境：某些功能已經有穩定的 C 函式庫可以使用，若能直接呼叫這些現有資源，就能避免重複造輪子。<br>Go 語言本身提供了 <code>cgo</code> 這個工具，讓我們能順利地在 Go 程式中嵌入並呼叫 C 程式碼。</p><p>本文會帶你從基礎開始認識 <code>cgo</code>，並透過範例說明如何在 Go 專案中使用它。</p><h2 id=cgo-是什麼>cgo 是什麼？</h2><p><code>cgo</code> 是 Go 語言官方提供的工具，用來讓 Go 程式可以呼叫 C 語言的程式碼或函式庫。只要在 Go 程式碼中使用特殊的 <code>import "C"</code> 語法，就能在 Go 與 C 之間進行互操作。</p><h2 id=基本使用方式>基本使用方式</h2><p>最基本的 <code>cgo</code> 程式碼結構如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=cm>/*
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=cm>#include &lt;stdio.h&gt;
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=cm>#include &lt;stdlib.h&gt;
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=cm>*/</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=nx>C</span><span class=p>.</span><span class=nf>puts</span><span class=p>(</span><span class=nx>C</span><span class=p>.</span><span class=nf>CString</span><span class=p>(</span><span class=s>&#34;Hello from C!&#34;</span><span class=p>))</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>    </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Hello from Go!&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>在這段程式中：</p><ul><li><code>/* ... */</code> 區塊中的程式碼會被視為 C 語言程式碼。</li><li><code>import "C"</code> 表示我們要使用 <code>cgo</code>。</li><li><code>C.puts</code> 即呼叫了 C 標準函式庫的 <code>puts</code>。</li></ul><p>執行結果會依序輸出：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=ln>1</span><span class=cl>Hello from C!
</span></span><span class=line><span class=ln>2</span><span class=cl>Hello from Go!
</span></span></code></pre></div><h2 id=c-型別的取用>C 型別的取用</h2><p>在使用 <code>cgo</code> 時，Go 與 C 型別必須正確對應。常見的幾個範例如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>1</span><span class=cl><span class=kd>var</span><span class=w> </span><span class=nx>a</span><span class=w> </span><span class=nx>C</span><span class=p>.</span><span class=kt>int</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>10</span><span class=w>      </span><span class=c1>// C 的 int 型別</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w></span><span class=kd>var</span><span class=w> </span><span class=nx>b</span><span class=w> </span><span class=nx>C</span><span class=p>.</span><span class=nx>char</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=sc>&#39;A&#39;</span><span class=w>    </span><span class=c1>// C 的 char 型別</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w></span><span class=kd>var</span><span class=w> </span><span class=nx>c</span><span class=w> </span><span class=nx>C</span><span class=p>.</span><span class=nx>size_t</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=mi>100</span><span class=w>  </span><span class=c1>// C 的 size_t 型別</span><span class=w>
</span></span></span></code></pre></div><h3 id=go-與-c-的字串轉換>Go 與 C 的字串轉換</h3><p>C 使用 <code>char*</code> 表示字串，而 Go 使用 <code>string</code>。兩者需要透過轉換：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>1</span><span class=cl><span class=nx>cs</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>C</span><span class=p>.</span><span class=nf>CString</span><span class=p>(</span><span class=s>&#34;hello&#34;</span><span class=p>)</span><span class=w>       </span><span class=c1>// Go string -&gt; C string</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w></span><span class=nx>C</span><span class=p>.</span><span class=nf>free</span><span class=p>(</span><span class=nx>unsafe</span><span class=p>.</span><span class=nf>Pointer</span><span class=p>(</span><span class=nx>cs</span><span class=p>))</span><span class=w>      </span><span class=c1>// 使用完畢後必須釋放記憶體</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w></span><span class=nx>goStr</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>C</span><span class=p>.</span><span class=nf>GoString</span><span class=p>(</span><span class=nx>cs</span><span class=p>)</span><span class=w>         </span><span class=c1>// C string -&gt; Go string</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w></span><span class=nx>goStrN</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>C</span><span class=p>.</span><span class=nf>GoStringN</span><span class=p>(</span><span class=nx>cs</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>)</span><span class=w>    </span><span class=c1>// 指定長度的轉換</span><span class=w>
</span></span></span></code></pre></div><p>當 Go 傳 Go pointer 給 C 時：
Go 會自動把該區域的記憶體「pin（釘住）」，直到呼叫結束，避免 GC 將內容搬移。<br>如果 C 要留存 Go pointer，必須透過 <code>runtime.Pinner</code>，或使用 <code>runtime/cgo.Handle</code> 進行安全管理。<br>另外也有 <code>GODEBUG=cgocheck=1</code>（預設）來做動態檢查，若要關閉可以 <code>GODEBUG=cgocheck=0</code>，而更嚴格檢查則可開 <code>GOEXPERIMENT=cgocheck2</code>。</p><h2 id=go-與-c-型別對應表>Go 與 C 型別對應表</h2><p>下表列出常見的 Go 與 C 型別對應：</p><table><thead><tr><th>C 型別</th><th>Go 對應型別</th><th>說明</th></tr></thead><tbody><tr><td><code>char</code></td><td><code>C.char</code></td><td>單一字元</td></tr><tr><td><code>signed char</code></td><td><code>C.schar</code></td><td>有號字元</td></tr><tr><td><code>unsigned char</code></td><td><code>C.uchar</code></td><td>無號字元</td></tr><tr><td><code>short</code></td><td><code>C.short</code></td><td>短整數</td></tr><tr><td><code>unsigned short</code></td><td><code>C.ushort</code></td><td>無號短整數</td></tr><tr><td><code>int</code></td><td><code>C.int</code></td><td>整數</td></tr><tr><td><code>unsigned int</code></td><td><code>C.uint</code></td><td>無號整數</td></tr><tr><td><code>long</code></td><td><code>C.long</code></td><td>長整數</td></tr><tr><td><code>unsigned long</code></td><td><code>C.ulong</code></td><td>無號長整數</td></tr><tr><td><code>long long</code></td><td><code>C.longlong</code></td><td>更長的整數</td></tr><tr><td><code>unsigned long long</code></td><td><code>C.ulonglong</code></td><td>無號更長的整數</td></tr><tr><td><code>float</code></td><td><code>C.float</code></td><td>單精度浮點</td></tr><tr><td><code>double</code></td><td><code>C.double</code></td><td>雙精度浮點</td></tr><tr><td><code>size_t</code></td><td><code>C.size_t</code></td><td>記憶體大小或索引</td></tr><tr><td><code>void*</code></td><td><code>unsafe.Pointer</code></td><td>通用指標</td></tr></tbody></table><p>這張表對於撰寫 Cgo 程式相當實用，可以幫助你快速找到對應的型別。</p><h2 id=定義編譯器旗標cflagsldflags>定義編譯器旗標（CFLAGS、LDFLAGS）</h2><p>在 preamble 中可以用 #cgo 指令指定額外的編譯或連結參數：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>1</span><span class=cl><span class=c1>// #cgo CFLAGS: -DPNG_DEBUG=1</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w></span><span class=c1>// #cgo LDFLAGS: -lpng</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w></span><span class=c1>// #include &lt;png.h&gt;</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=s>&#34;C&#34;</span><span class=w>
</span></span></span></code></pre></div><p>若透過 pkg-config 取得設定，也支援這種寫法：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>1</span><span class=cl><span class=c1>// #cgo pkg-config: png cairo</span><span class=w>
</span></span></span></code></pre></div><p>這些旗標會依系統條件進行串接、合併使用，非常方便</p><h2 id=境變數與安全限制技巧>境變數與安全限制技巧</h2><p>建議盡量把特定包的 CFLAGS/LDFLAGS 用 #cgo 指令設定，而不要透過環境變數設定，因為後者不會套受 cgo 的安全機制限制：</p><p>cgo 對於允許的旗標有嚴格限制（例如 -D, -I, -l 等）；</p><p>若需要放寬限制，可以透過環境變數如 CGO_CFLAGS_ALLOW、CGO_CFLAGS_DISALLOW 設定正則表達式
Go Packages
。</p><h2 id=常見錯誤與除錯技巧>常見錯誤與除錯技巧</h2><p>在使用 <code>cgo</code> 的過程中，常見的錯誤包括：</p><ol><li><p><strong>找不到標頭檔</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;foo.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=cp></span><span class=n>fatal</span> <span class=nl>error</span><span class=p>:</span> <span class=n>foo</span><span class=p>.</span><span class=nl>h</span><span class=p>:</span> <span class=n>No</span> <span class=n>such</span> <span class=n>file</span> <span class=n>or</span> <span class=n>directory</span>
</span></span></code></pre></div><p>請確認系統已安裝相關開發套件，例如在 Debian/Ubuntu 中：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>sudo apt-get install libfoo-dev
</span></span></code></pre></div></li><li><p><strong>記憶體釋放問題</strong></p><ul><li>使用 <code>C.CString</code> 產生的字串必須手動 <code>C.free</code>，否則會造成 memory leak。</li></ul></li><li><p><strong>型別不相容</strong></p><ul><li><p>若將 <code>C.int</code> 直接指定給 Go 的 <code>int</code>，有時會出現編譯錯誤，建議使用明確轉型：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>1</span><span class=cl><span class=kd>var</span><span class=w> </span><span class=nx>g</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nb>int</span><span class=p>(</span><span class=nx>C</span><span class=p>.</span><span class=nb>int</span><span class=p>(</span><span class=mi>10</span><span class=p>))</span><span class=w>
</span></span></span></code></pre></div></li></ul></li><li><p><strong>交叉編譯失敗</strong></p><ul><li>由於 <code>cgo</code> 依賴 C 編譯器，若要交叉編譯（例如在 Linux 編譯給 Windows），需要安裝對應平台的 cross-compiler。</li></ul></li></ol><p>建議在開發初期就善用 <code>go build -x</code> 或 <code>CGO_ENABLED=0</code> 測試，這樣能更容易找到問題所在。</p><h2 id=小結>小結</h2><p>透過 <code>cgo</code>，我們可以將現有的 C 函式庫整合進 Go 專案，兼顧效能與開發效率。本文介紹了基本語法、C 型別取用方式、Go 與 C 型別對應表，以及常見錯誤的解決方式。未來若需要整合 C 函式庫，不妨動手試試，體驗 Go 與 C 的強大組合。</p></div><footer class=post-footer><div class=post-nav><a href=https://e61983.github.io/posts/use-docker-api-query-container-ip/ class=post-nav-prev><span class=nav-label>上一篇</span>
<span class=nav-title>在 Go 裡直接抓 Docker 容器 IP，連線 PostgreSQL</span>
</a><a href=https://e61983.github.io/posts/go-cgo-static-dynamic-link/ class=post-nav-next><span class=nav-label>下一篇</span>
<span class=nav-title>從 glibc 到 musl : 靜態編譯上的新選擇</span></a></div></footer></article><aside class=post-sidebar><nav class="toc desktop-toc"><h3 class=toc-title>目錄</h3><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#cgo-是什麼>cgo 是什麼？</a></li><li><a href=#基本使用方式>基本使用方式</a></li><li><a href=#c-型別的取用>C 型別的取用</a><ul><li><a href=#go-與-c-的字串轉換>Go 與 C 的字串轉換</a></li></ul></li><li><a href=#go-與-c-型別對應表>Go 與 C 型別對應表</a></li><li><a href=#定義編譯器旗標cflagsldflags>定義編譯器旗標（CFLAGS、LDFLAGS）</a></li><li><a href=#境變數與安全限制技巧>境變數與安全限制技巧</a></li><li><a href=#常見錯誤與除錯技巧>常見錯誤與除錯技巧</a></li><li><a href=#小結>小結</a></li></ul></nav></nav></aside></div></div><button id=backToTop class=back-to-top aria-label=回到頂部>
<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg></button></main><footer class=footer><div class=container><div class=footer-content><div class=social-links><a href=https://github.com/e61983 target=_blank rel=noopener class=social-link><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
GitHub</a></div><div class=copyright><p>&copy; 2025 Yuan. All rights reserved.</p><p>Powered by <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a> & Yuan Theme</p></div></div></div></footer></div><script src=https://e61983.github.io/yuan/js/main.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-FQ2NLS0SEB"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FQ2NLS0SEB",{send_page_view:!0,anonymize_ip:!0,allow_google_signals:!1,allow_ad_personalization_signals:!1})</script></body></html>