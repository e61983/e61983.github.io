<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>RabbitMQ！鎹鴉傳信的分工法 - 通往地獄的開始？！ - Yuan のノート</title><meta name=description content="心之所至，隨意亂書"><meta name=keywords content="golang,embedded,linux,backend,programming"><meta name=author content="Yuan"><meta property="og:title" content="RabbitMQ！鎹鴉傳信的分工法 - 通往地獄的開始？！ - Yuan のノート"><meta property="og:description" content="心之所至，隨意亂書"><meta property="og:type" content="article"><meta property="og:url" content="https://e61983.github.io/posts/rabbitmq-introduction/"><link rel=icon type=image/svg+xml href=/favicon.svg><link rel=icon type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/favicon.svg><meta name=theme-color content="#0d1117"><link rel=stylesheet href=https://e61983.github.io/yuan/css/main.min.css><link rel=stylesheet href=https://e61983.github.io/yuan/css/chroma.min.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel=stylesheet></head><body class=theme-dark><div class=layout><header class=header><div class=container><div class=header-content><div class=header-brand><a href=https://e61983.github.io/ class=brand-link><span class=brand-text>Yuan のノート</span></a><p class=brand-subtitle>心之所至，隨意亂書</p></div><nav class=nav><ul class=nav-list><li class=nav-item><a href=/ class=nav-link>首頁</a></li><li class=nav-item><a href=/posts/ class=nav-link>文章</a></li><li class=nav-item><a href=/categories/ class=nav-link>分類</a></li><li class=nav-item><a href=/tags/ class=nav-link>標籤</a></li><li class=nav-item><a href=/archive/ class=nav-link>歸檔</a></li></ul></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span class=hamburger></span>
<span class=hamburger></span>
<span class=hamburger></span></button></div></div></header><main class=main><div class=container><div class=post-layout><article class=post><header class=post-header><h1 class=post-title>RabbitMQ！鎹鴉傳信的分工法 - 通往地獄的開始？！</h1><div class=post-meta><time class=post-date datetime=2025-09-22T23:04:47+08:00>2025年09月22日
</time><span class=reading-time>4 分鐘閱讀</span>
<span class=word-count>758 字</span></div><div class=post-tags><a href=/tags/rabbitmq class=tag>RabbitMQ</a>
<a href=/tags/go class=tag>Go</a>
<a href=/tags/docker class=tag>Docker</a>
<a href=/tags/message-queue class=tag>Message Queue</a></div></header><div class=mobile-toc-toggle><button class=toc-toggle-btn aria-label=顯示/隱藏目錄>
<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h14v-2H3v2zm16 0h2v-2h-2v2zm0-10v2h2V7h-2zm0 6h2v-2h-2v2z"/></svg>
目錄</button><nav class=mobile-toc><h3 class=toc-title>目錄</h3><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#rabbitmq-是什麼>RabbitMQ 是什麼？</a></li><li><a href=#常見設計模式>常見設計模式</a></li><li><a href=#用-docker-compose-架設-rabbitmq>用 Docker Compose 架設 RabbitMQ</a><ul><li><a href=#definitionsjson>definitions.json</a></li><li><a href=#rabbitmqconf>rabbitmq.conf</a></li></ul></li><li><a href=#使用-go-舉個栗子producer--consumer>使用 Go 舉個栗子：Producer & Consumer</a><ul><li><a href=#producer-發送訊息>Producer (發送訊息)</a></li><li><a href=#consumer-接收訊息>Consumer (接收訊息)</a></li></ul></li><li><a href=#環境配置建議>環境配置建議</a></li><li><a href=#資源限制>資源限制</a><ul><li><a href=#docker-compose-限制>Docker Compose 限制</a></li><li><a href=#rabbitmq-配置>RabbitMQ 配置</a></li></ul></li><li><a href=#除錯指南常用-shell-指令>除錯指南：常用 Shell 指令</a></li><li><a href=#參考資料>參考資料</a></li><li><a href=#結語>結語</a></li></ul></nav></nav></div><div class=post-content><h2 id=前言>前言</h2><p>在鬼殺隊的任務分派中，如果沒有調度中心，任務可能會亂七八糟。<br>想像一下：如果所有柱同時衝去打同一隻鬼，那些在另一邊肆虐的鬼該怎麼辦？</p><p>這時候，我們需要一個「訊息中介」來幫忙分配工作。<br>就像<strong>蟲柱 蝴蝶忍</strong>負責調度藥物與情報，<strong>炎柱 煉獄杏壽郎</strong>帶領隊伍作戰一樣 ——<br>這個「中介人」在系統世界裡，就是 <strong>RabbitMQ</strong>。</p><h2 id=rabbitmq-是什麼>RabbitMQ 是什麼？</h2><p>RabbitMQ 是一個 <strong>訊息代理系統 (Message Broker)</strong>。<br>它能接收來自一方的訊息（Producer），暫存在 <strong>Queue</strong>，再由另一方（Consumer）處理。</p><p>換句話說，它就像<strong>鬼殺隊的任務分派所</strong>：</p><ul><li>產生任務的人 = Producer</li><li>任務清單 = Queue</li><li>接任務的劍士 = Consumer</li><li>Exchange 則是「分派邏輯」：決定哪個任務要派給誰。</li></ul><h2 id=常見設計模式>常見設計模式</h2><div class=mermaid>flowchart LR
subgraph WorkQueue["工作隊列（任務分工）"]
P1["Producer（任務所）"] --> Q1["Queue（任務清單）"]
Q1 --> C1["劍士 1"]
Q1 --> C2["劍士 2"]
end
subgraph PubSub["發佈 / 訂閱（情報共享）"]
P2["Producer（鎹鴉傳信）"] --> E1["Fanout Exchange（情報放送）"]
E1 --> Q2["炎柱專用清單"]
E1 --> Q3["音柱專用清單"]
Q2 --> C3["炎柱 煉獄"]
Q3 --> C4["音柱 宇髄"]
end
subgraph Routing["路由（分類調度）"]
P3["Producer（鬼情報）"] --> E2["Topic Exchange（情報分流）"]
E2 -->|routing_key=上弦| Q4["高危任務清單"]
E2 -->|routing_key=下弦| Q5["低危任務清單"]
Q4 --> C5["水柱 富岡"]
Q5 --> C6["善逸 & 伊之助"]
end</div><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
        startOnLoad: true,
        theme: 'dark',
        themeVariables: {
            primaryColor: '#bb2528',
            primaryTextColor: '#fff',
            primaryBorderColor: '#7C0000',
            lineColor: '#F8B229',
            background: '#0d1117',
            mainBkg: '#161b22',
            secondBkg: '#21262d',
            tertiaryColor: '#21262d'
        }
    });
</script><ul><li><strong>工作隊列</strong>：就像分工出擊，多個劍士平分戰場。</li><li><strong>發佈/訂閱</strong>：情報同時發送給不同柱。</li><li><strong>路由模式</strong>：不同強度的鬼交給不同等級的劍士處理。</li></ul><h2 id=用-docker-compose-架設-rabbitmq>用 Docker Compose 架設 RabbitMQ</h2><p>在現代開發環境中，我們常透過 Docker Compose 來快速啟動 RabbitMQ。
以下配置同時展示了 <strong>definitions.json</strong>（自動初始化設定），讓 RabbitMQ 啟動就有使用者、vhost、queue 與 exchange。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln> 1</span><span class=cl><span class=nt>services</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>  </span><span class=nt>rabbitmq</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>    </span><span class=nt>image</span><span class=p>:</span><span class=w> </span><span class=l>rabbitmq:3.13-management</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>    </span><span class=nt>container_name</span><span class=p>:</span><span class=w> </span><span class=l>rabbitmq</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>    </span><span class=nt>ports</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>      </span>- <span class=s2>&#34;5672:5672&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>      </span>- <span class=s2>&#34;15672:15672&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>      </span>- <span class=l>rabbitmq_data:/var/lib/rabbitmq</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>      </span>- <span class=l>./rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>      </span>- <span class=l>./definitions.json:/etc/rabbitmq/definitions.json:ro</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>    </span><span class=nt>deploy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>      </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>        </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>          </span><span class=nt>cpus</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1.0&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>          </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512M</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w></span><span class=nt>volumes</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>  </span><span class=nt>rabbitmq_data</span><span class=p>:</span><span class=w>
</span></span></span></code></pre></div><h3 id=definitionsjson>definitions.json</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=ln> 1</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=nt>&#34;users&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=p>{</span> <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;appuser&#34;</span><span class=p>,</span> <span class=nt>&#34;password_hash&#34;</span><span class=p>:</span> <span class=s2>&#34;V6pRsZxUi7UgkFHFdS1MGf3TRmBe8HLSn3speAQZqGAZrkuB&#34;</span><span class=p>,</span> <span class=nt>&#34;tags&#34;</span><span class=p>:</span> <span class=s2>&#34;management&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>  <span class=nt>&#34;vhosts&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=p>{</span> <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;/app&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=nt>&#34;permissions&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>      <span class=nt>&#34;user&#34;</span><span class=p>:</span> <span class=s2>&#34;appuser&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>      <span class=nt>&#34;vhost&#34;</span><span class=p>:</span> <span class=s2>&#34;/app&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>      <span class=nt>&#34;configure&#34;</span><span class=p>:</span> <span class=s2>&#34;.*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>      <span class=nt>&#34;write&#34;</span><span class=p>:</span> <span class=s2>&#34;.*&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>      <span class=nt>&#34;read&#34;</span><span class=p>:</span> <span class=s2>&#34;.*&#34;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>  <span class=nt>&#34;queues&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=p>{</span> <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;task_queue&#34;</span><span class=p>,</span> <span class=nt>&#34;vhost&#34;</span><span class=p>:</span> <span class=s2>&#34;/app&#34;</span><span class=p>,</span> <span class=nt>&#34;durable&#34;</span><span class=p>:</span> <span class=kc>true</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>  <span class=nt>&#34;exchanges&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=p>{</span> <span class=nt>&#34;name&#34;</span><span class=p>:</span> <span class=s2>&#34;logs&#34;</span><span class=p>,</span> <span class=nt>&#34;vhost&#34;</span><span class=p>:</span> <span class=s2>&#34;/app&#34;</span><span class=p>,</span> <span class=nt>&#34;type&#34;</span><span class=p>:</span> <span class=s2>&#34;fanout&#34;</span><span class=p>,</span> <span class=nt>&#34;durable&#34;</span><span class=p>:</span> <span class=kc>true</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>  <span class=p>],</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>  <span class=nt>&#34;bindings&#34;</span><span class=p>:</span> <span class=p>[</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>    <span class=p>{</span> <span class=nt>&#34;source&#34;</span><span class=p>:</span> <span class=s2>&#34;logs&#34;</span><span class=p>,</span> <span class=nt>&#34;vhost&#34;</span><span class=p>:</span> <span class=s2>&#34;/app&#34;</span><span class=p>,</span> <span class=nt>&#34;destination&#34;</span><span class=p>:</span> <span class=s2>&#34;task_queue&#34;</span><span class=p>,</span> <span class=nt>&#34;destination_type&#34;</span><span class=p>:</span> <span class=s2>&#34;queue&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>  <span class=p>]</span>
</span></span><span class=line><span class=ln>26</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><blockquote><p><strong>注意</strong>：在 definitions.json 中，密碼必須使用 <code>password_hash</code> 而不是 <code>password</code>，且值必須是 hash 過的字串。<br>可以使用 <code>docker exec rabbitmq rabbitmqctl hash_password 你的密碼</code> 來產生 hash 值。</p></blockquote><h3 id=rabbitmqconf>rabbitmq.conf</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-gdscript3 data-lang=gdscript3><span class=line><span class=ln>1</span><span class=cl><span class=n>load_definitions</span> <span class=o>=</span> <span class=o>/</span><span class=n>etc</span><span class=o>/</span><span class=n>rabbitmq</span><span class=o>/</span><span class=n>definitions</span><span class=o>.</span><span class=n>json</span>
</span></span></code></pre></div><h2 id=使用-go-舉個栗子producer--consumer>使用 Go 舉個栗子：Producer & Consumer</h2><p>在隊伍中，<strong>Producer 就像是鎹鴉</strong>，<strong>Consumer 就像是劍士</strong>。</p><blockquote><p><strong>重要</strong>：在實際開發中，<strong>務必處理所有錯誤</strong>！使用 <code>_</code> 忽略錯誤會導致 <code>nil pointer dereference</code> 的 panic。</p></blockquote><h3 id=producer-發送訊息>Producer (發送訊息)</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>    </span><span class=s>&#34;log&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=nx>amqp</span><span class=w> </span><span class=s>&#34;github.com/rabbitmq/amqp091-go&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=c1>// 建立連接，並處理錯誤</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=nx>conn</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>amqp</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=s>&#34;amqp://appuser:apppass@localhost:5672//app&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to connect to RabbitMQ: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=c1>// 建立通道，並處理錯誤</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>    </span><span class=nx>ch</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>conn</span><span class=p>.</span><span class=nf>Channel</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to open a channel: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>    </span><span class=c1>// 宣告 Queue，並處理錯誤</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>    </span><span class=nx>q</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nf>QueueDeclare</span><span class=p>(</span><span class=s>&#34;task_queue&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to declare a queue: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>    </span><span class=nx>body</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=s>&#34;柱 集結！&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>    </span><span class=nx>err</span><span class=w> </span><span class=p>=</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nf>Publish</span><span class=p>(</span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>q</span><span class=p>.</span><span class=nx>Name</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>        </span><span class=nx>amqp</span><span class=p>.</span><span class=nx>Publishing</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>            </span><span class=nx>DeliveryMode</span><span class=p>:</span><span class=w> </span><span class=nx>amqp</span><span class=p>.</span><span class=nx>Persistent</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>            </span><span class=nx>ContentType</span><span class=p>:</span><span class=w>  </span><span class=s>&#34;text/plain&#34;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>            </span><span class=nx>Body</span><span class=p>:</span><span class=w>         </span><span class=p>[]</span><span class=nb>byte</span><span class=p>(</span><span class=nx>body</span><span class=p>),</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>        </span><span class=p>})</span><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to publish a message: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Sent:&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>body</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h3 id=consumer-接收訊息>Consumer (接收訊息)</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln> 1</span><span class=cl><span class=kn>package</span><span class=w> </span><span class=nx>main</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=p>(</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>    </span><span class=s>&#34;fmt&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>    </span><span class=s>&#34;log&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>    </span><span class=nx>amqp</span><span class=w> </span><span class=s>&#34;github.com/rabbitmq/amqp091-go&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w></span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span><span class=kd>func</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>    </span><span class=c1>// 建立連接，並處理錯誤</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>    </span><span class=nx>conn</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>amqp</span><span class=p>.</span><span class=nf>Dial</span><span class=p>(</span><span class=s>&#34;amqp://appuser:apppass@localhost:5672//app&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to connect to RabbitMQ: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>conn</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>    </span><span class=c1>// 建立通道，並處理錯誤</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>    </span><span class=nx>ch</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>conn</span><span class=p>.</span><span class=nf>Channel</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to open a channel: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>    </span><span class=k>defer</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nf>Close</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>    </span><span class=c1>// 開始消費訊息，並處理錯誤</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>    </span><span class=nx>msgs</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=nx>ch</span><span class=p>.</span><span class=nf>Consume</span><span class=p>(</span><span class=s>&#34;task_queue&#34;</span><span class=p>,</span><span class=w> </span><span class=s>&#34;&#34;</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>false</span><span class=p>,</span><span class=w> </span><span class=kc>nil</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=nx>err</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>nil</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>        </span><span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;Failed to register a consumer: %v&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>err</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>    </span><span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;Waiting for missions...&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=nx>d</span><span class=w> </span><span class=o>:=</span><span class=w> </span><span class=k>range</span><span class=w> </span><span class=nx>msgs</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>        </span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Printf</span><span class=p>(</span><span class=s>&#34;Received任務: %s\n&#34;</span><span class=p>,</span><span class=w> </span><span class=nx>d</span><span class=p>.</span><span class=nx>Body</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>        </span><span class=nx>d</span><span class=p>.</span><span class=nf>Ack</span><span class=p>(</span><span class=kc>false</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=環境配置建議>環境配置建議</h2><ol><li><p><strong>Cluster + Quorum Queue</strong></p><ul><li>就像多個鬼殺隊據點，確保任務清單不會因單一據點毀滅而消失。</li><li>建議至少 3 節點，使用 <strong>Quorum Queue</strong> 代替傳統 Mirrored Queue。</li></ul></li><li><p><strong>初始化（Definitions 檔案）</strong></p><ul><li>透過 <code>definitions.json</code> 自動建立 vhost、使用者、queue 與 exchange。</li><li>好處：部署流程標準化，不怕人為失誤。</li></ul></li><li><p><strong>監控與告警</strong></p><ul><li>使用 <strong>Prometheus + Grafana</strong> 監控 queue 長度、記憶體、磁碟使用量。</li><li>若「訊息堆積如山」就要趕快多派幾個 worker。</li></ul></li></ol><h2 id=資源限制>資源限制</h2><p>RabbitMQ 若不加限制，可能像<strong>無慘的細胞分裂</strong>一樣暴走。
以下方法可控制 RAM、磁碟與 CPU 使用：</p><h3 id=docker-compose-限制>Docker Compose 限制</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=ln>1</span><span class=cl><span class=nt>deploy</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>  </span><span class=nt>resources</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>    </span><span class=nt>limits</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>      </span><span class=nt>cpus</span><span class=p>:</span><span class=w> </span><span class=s2>&#34;1.0&#34;</span><span class=w>     </span><span class=c># 最多 1 顆 CPU</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>      </span><span class=nt>memory</span><span class=p>:</span><span class=w> </span><span class=l>512M   </span><span class=w> </span><span class=c># 最多 512 MB RAM</span><span class=w>
</span></span></span></code></pre></div><h3 id=rabbitmq-配置>RabbitMQ 配置</h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=ln>1</span><span class=cl># 記憶體最多用系統 RAM 的 40%
</span></span><span class=line><span class=ln>2</span><span class=cl>vm_memory_high_watermark.relative = 0.4
</span></span><span class=line><span class=ln>3</span><span class=cl>
</span></span><span class=line><span class=ln>4</span><span class=cl># 磁碟不足 2GB 就暫停寫入
</span></span><span class=line><span class=ln>5</span><span class=cl>disk_free_limit.absolute = 2GB
</span></span></code></pre></div><h2 id=除錯指南常用-shell-指令>除錯指南：常用 Shell 指令</h2><ul><li>檢查容器是否正在運行：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>docker ps <span class=p>|</span> grep rabbitmq
</span></span></code></pre></div><ul><li>列出使用者（確認帳號是否存在、標籤是否正確）：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>docker <span class=nb>exec</span> rabbitmq rabbitmqctl list_users
</span></span></code></pre></div><ul><li>列出 vhost（確認目標 vhost 是否存在，注意根目錄 vhost 為「/」）：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>docker <span class=nb>exec</span> rabbitmq rabbitmqctl list_vhosts
</span></span></code></pre></div><ul><li>查看指定 vhost 的權限（確認使用者是否擁有 read/write/configure）：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>docker <span class=nb>exec</span> rabbitmq rabbitmqctl list_permissions -p /app
</span></span></code></pre></div><ul><li>變更使用者密碼（快速與程式使用的密碼對齊）：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>docker <span class=nb>exec</span> rabbitmq rabbitmqctl change_password appuser apppass
</span></span></code></pre></div><ul><li>產生密碼雜湊（當使用 definitions.json 初始化需要 password_hash 時）：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>docker <span class=nb>exec</span> rabbitmq rabbitmqctl hash_password apppass
</span></span></code></pre></div><ul><li>查看最近日誌（快速定位連線被拒原因，例如 vhost not found）：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>docker logs rabbitmq --tail <span class=m>50</span>
</span></span></code></pre></div><ul><li>AMQP 連線字串小抄（/app 需使用 URL 編碼或雙斜線）：</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># 兩種等價寫法（指向 vhost &#34;/app&#34;）</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>amqp://appuser:apppass@localhost:5672//app
</span></span><span class=line><span class=ln>3</span><span class=cl>amqp://appuser:apppass@localhost:5672/%2Fapp
</span></span></code></pre></div><h2 id=參考資料>參考資料</h2><ul><li><a href=https://www.rabbitmq.com/documentation.html>RabbitMQ 官方文件</a></li><li><a href=https://hub.docker.com/_/rabbitmq>RabbitMQ Docker Hub</a></li><li><a href=https://pkg.go.dev/github.com/rabbitmq/amqp091-go>Go RabbitMQ client (amqp091-go)</a></li></ul><h2 id=結語>結語</h2><p>RabbitMQ 就像鬼殺隊的「任務分派中心」。
透過 <strong>Docker Compose</strong>，我們能快速建立環境；
透過 <strong>Go 的 Producer / Consumer</strong>，我們能即時傳遞訊息；
透過 <strong>definitions.json</strong>，我們能讓配置自動化，避免人手操作失誤。</p><p>在生產環境中，記得啟用 <strong>Cluster + Quorum Queue</strong>，
並設好 <strong>資源限制與監控</strong>，才能確保隊伍不會因系統壓力而崩潰。</p></div><footer class=post-footer><div class=post-nav><a href=https://e61983.github.io/posts/use-go-update-elf-section/ class=post-nav-prev><span class=nav-label>上一篇</span>
<span class=nav-title>去找吧！我把所有資料都藏在那了 - 通向 Section 航道的旅程</span>
</a><a href=https://e61983.github.io/posts/graphql-introduction/ class=post-nav-next><span class=nav-label>下一篇</span>
<span class=nav-title>初探 GraphQL</span></a></div></footer></article><aside class=post-sidebar><nav class="toc desktop-toc"><h3 class=toc-title>目錄</h3><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#rabbitmq-是什麼>RabbitMQ 是什麼？</a></li><li><a href=#常見設計模式>常見設計模式</a></li><li><a href=#用-docker-compose-架設-rabbitmq>用 Docker Compose 架設 RabbitMQ</a><ul><li><a href=#definitionsjson>definitions.json</a></li><li><a href=#rabbitmqconf>rabbitmq.conf</a></li></ul></li><li><a href=#使用-go-舉個栗子producer--consumer>使用 Go 舉個栗子：Producer & Consumer</a><ul><li><a href=#producer-發送訊息>Producer (發送訊息)</a></li><li><a href=#consumer-接收訊息>Consumer (接收訊息)</a></li></ul></li><li><a href=#環境配置建議>環境配置建議</a></li><li><a href=#資源限制>資源限制</a><ul><li><a href=#docker-compose-限制>Docker Compose 限制</a></li><li><a href=#rabbitmq-配置>RabbitMQ 配置</a></li></ul></li><li><a href=#除錯指南常用-shell-指令>除錯指南：常用 Shell 指令</a></li><li><a href=#參考資料>參考資料</a></li><li><a href=#結語>結語</a></li></ul></nav></nav></aside></div></div><button id=backToTop class=back-to-top aria-label=回到頂部>
<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg></button></main><footer class=footer><div class=container><div class=footer-content><div class=social-links><a href=https://github.com/e61983 target=_blank rel=noopener class=social-link><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
GitHub</a></div><div class=copyright><p>&copy; 2025 Yuan. All rights reserved.</p><p>Powered by <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a> & Yuan Theme</p></div></div></div></footer></div><script src=https://e61983.github.io/yuan/js/main.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-FQ2NLS0SEB"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FQ2NLS0SEB",{send_page_view:!0,anonymize_ip:!0,allow_google_signals:!1,allow_ad_personalization_signals:!1})</script></body></html>