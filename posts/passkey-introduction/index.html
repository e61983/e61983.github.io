<!doctype html><html lang=en><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>用 Go 打造 Passkey（WebAuthn）最小可行產品：從原理到 MVP 實作 - Yuan のノート</title><meta name=description content="從零開始用 Go 實作 Passkey/WebAuthn 認證系統，包含完整的註冊與登入流程，讓你快速理解無密碼登入的核心原理與實作細節。"><meta name=keywords content="golang,embedded,linux,backend,programming"><meta name=author content="Yuan"><meta property="og:title" content="用 Go 打造 Passkey（WebAuthn）最小可行產品：從原理到 MVP 實作 - Yuan のノート"><meta property="og:description" content="從零開始用 Go 實作 Passkey/WebAuthn 認證系統，包含完整的註冊與登入流程，讓你快速理解無密碼登入的核心原理與實作細節。"><meta property="og:type" content="article"><meta property="og:url" content="https://e61983.github.io/posts/passkey-introduction/"><link rel=icon type=image/svg+xml href=/favicon.svg><link rel=icon type=image/x-icon href=/favicon.ico><link rel=apple-touch-icon sizes=180x180 href=/favicon.svg><meta name=theme-color content="#0d1117"><link rel=stylesheet href=https://e61983.github.io/yuan/css/main.min.css><link rel=stylesheet href=https://e61983.github.io/yuan/css/chroma.min.css><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;700&family=Inter:wght@300;400;500;600;700&display=swap" rel=stylesheet></head><body class=theme-dark><div class=layout><header class=header><div class=container><div class=header-content><div class=header-brand><a href=https://e61983.github.io/ class=brand-link><span class=brand-text>Yuan のノート</span></a><p class=brand-subtitle>心之所至，隨意亂書</p></div><nav class=nav><ul class=nav-list><li class=nav-item><a href=/ class=nav-link>首頁</a></li><li class=nav-item><a href=/posts/ class=nav-link>文章</a></li><li class=nav-item><a href=/categories/ class=nav-link>分類</a></li><li class=nav-item><a href=/tags/ class=nav-link>標籤</a></li><li class=nav-item><a href=/archive/ class=nav-link>歸檔</a></li></ul></nav><button class=mobile-menu-toggle aria-label="Toggle menu">
<span class=hamburger></span>
<span class=hamburger></span>
<span class=hamburger></span></button></div></div></header><main class=main><div class=container><div class=post-layout><article class=post><header class=post-header><h1 class=post-title>用 Go 打造 Passkey（WebAuthn）最小可行產品：從原理到 MVP 實作</h1><div class=post-meta><time class=post-date datetime=2025-08-25T23:45:30+08:00>2025年08月25日
</time><span class=reading-time>10 分鐘閱讀</span>
<span class=word-count>2129 字</span>
<span class=post-author>by Yuan</span></div><div class=post-tags><a href=/tags/go class=tag>go</a>
<a href=/tags/webauthn class=tag>webauthn</a>
<a href=/tags/passkey class=tag>passkey</a>
<a href=/tags/security class=tag>security</a>
<a href=/tags/authentication class=tag>authentication</a>
<a href=/tags/mvp class=tag>mvp</a>
<a href=/tags/website class=tag>website</a>
<a href=/tags/backend class=tag>backend</a></div><div class=post-categories><a href=/categories/website class=category>website</a>
<a href=/categories/security class=category>security</a></div></header><div class=mobile-toc-toggle><button class=toc-toggle-btn aria-label=顯示/隱藏目錄>
<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M3 9h14V7H3v2zm0 4h14v-2H3v2zm0 4h14v-2H3v2zm16 0h2v-2h-2v2zm0-10v2h2V7h-2zm0 6h2v-2h-2v2z"/></svg>
目錄</button><nav class=mobile-toc><h3 class=toc-title>目錄</h3><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#目標>目標</a></li><li><a href=#passkey-是什麼>Passkey 是什麼？</a></li><li><a href=#passkey-工作流程>Passkey 工作流程</a><ul><li><a href=#註冊流程registration>註冊流程（Registration）</a></li><li><a href=#登入流程authentication>登入流程（Authentication）</a></li></ul></li><li><a href=#我們要做的-mvp>我們要做的 MVP</a><ul><li><a href=#架構與流程>架構與流程</a></li></ul></li><li><a href=#後端go>後端（Go）</a></li><li><a href=#前端html--css--js>前端（HTML + CSS + JS）</a></li><li><a href=#跑起來>跑起來</a></li><li><a href=#常見問題mvp-版本>常見問題（MVP 版本）</a></li><li><a href=#延伸與強化>延伸與強化</a></li><li><a href=#總結>總結</a></li></ul></nav></nav></div><div class=post-content><h2 id=前言>前言</h2><p>「把密碼換成裝置裡的私鑰」——這就是 Passkey 的核心概念。
我們用最小可行的方式，寫一個可以真的註冊與登入的 WebAuthn 小服務。</p><h2 id=目標>目標</h2><ul><li>用 <strong>公私鑰</strong>（FIDO2/WebAuthn）取代傳統密碼。</li><li>實作 <strong>註冊</strong>（建立金鑰對）與 <strong>登入</strong>（challenge 簽章驗證）。</li><li>後端：<strong>Go</strong>；前端：<strong>HTML + CSS + JavaScript</strong>，純瀏覽器原生 API（<code>navigator.credentials.create/get</code>）。</li><li>用最小依賴打造能跑的 MVP，幫助你理解並能快速 PoC。</li></ul><hr><h2 id=passkey-是什麼>Passkey 是什麼？</h2><ul><li><strong>不再記密碼</strong>：使用者只需要用裝置上的生物辨識/PIN 解鎖「私鑰」。</li><li><strong>伺服器只存公鑰</strong>：挑戰（challenge）由伺服器發出，裝置用私鑰簽章回傳，伺服器用公鑰驗證。</li><li><strong>抗釣魚</strong>：RP（網站）綁定 + 起源（origin）驗證，降低釣魚風險。</li></ul><hr><h2 id=passkey-工作流程>Passkey 工作流程</h2><h3 id=註冊流程registration>註冊流程（Registration）</h3><p>用戶首次建立 Passkey 時的流程：</p><div class=mermaid>sequenceDiagram
participant User as 使用者
participant Browser as 瀏覽器
participant Server as 後端伺服器
participant Auth as 裝置認證器<br>(TouchID/FaceID/Windows Hello)
User->>Browser: 點擊「註冊 Passkey」
Browser->>Server: POST /api/register/start<br>{ username }
Server->>Browser: 回傳 CreationOptions<br>{ challenge, user, rp }
Browser->>Auth: navigator.credentials.create()
Auth->>User: 請求生物辨識驗證
User->>Auth: 指紋/臉部/PIN 驗證
Auth->>Auth: 產生公私鑰對
Auth->>Browser: 回傳 AttestationResponse<br>{ publicKey, signature }
Browser->>Server: POST /api/register/finish<br>{ attestationObject }
Server->>Server: 驗證 & 儲存公鑰
Server->>Browser: 註冊成功</div><script type=module>
    import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
    mermaid.initialize({
        startOnLoad: true,
        theme: 'dark',
        themeVariables: {
            primaryColor: '#bb2528',
            primaryTextColor: '#fff',
            primaryBorderColor: '#7C0000',
            lineColor: '#F8B229',
            background: '#0d1117',
            mainBkg: '#161b22',
            secondBkg: '#21262d',
            tertiaryColor: '#21262d'
        }
    });
</script><h3 id=登入流程authentication>登入流程（Authentication）</h3><p>用戶使用已註冊的 Passkey 進行登入：</p><div class=mermaid>sequenceDiagram
participant User as 使用者
participant Browser as 瀏覽器
participant Server as 後端伺服器
participant Auth as 裝置認證器
User->>Browser: 點擊「使用 Passkey 登入」
Browser->>Server: POST /api/login/start<br>{ username }
Server->>Server: 產生隨機 challenge
Server->>Browser: 回傳 RequestOptions<br>{ challenge, allowCredentials }
Browser->>Auth: navigator.credentials.get()
Auth->>User: 請求生物辨識驗證
User->>Auth: 指紋/臉部/PIN 驗證
Auth->>Auth: 用私鑰簽署 challenge
Auth->>Browser: 回傳 AssertionResponse<br>{ signature, authenticatorData }
Browser->>Server: POST /api/login/finish<br>{ signature, clientData }
Server->>Server: 用公鑰驗證簽章
Server->>Browser: 登入成功</div><hr><h2 id=我們要做的-mvp>我們要做的 MVP</h2><h3 id=架構與流程>架構與流程</h3><ul><li><code>/</code>：靜態頁（含兩個按鈕：註冊、登入）。</li><li><code>/api/register/start</code> → 前端拿到 <strong>PublicKeyCredentialCreationOptions</strong> → 呼叫 <code>navigator.credentials.create()</code> →
把結果送到 <code>/api/register/finish</code> 完成註冊。</li><li><code>/api/login/start</code> → 前端拿到 <strong>PublicKeyCredentialRequestOptions</strong> → 呼叫 <code>navigator.credentials.get()</code> →
把結果送到 <code>/api/login/finish</code> 完成登入。</li></ul><p><strong>狀態</strong></p><ul><li>使用簡單的 in-memory 儲存（使用者與憑證），並用 cookie <code>sid</code> 對應一次性的 WebAuthn SessionData。</li><li>Demo 夠用，正式環境請改用資料庫與安全的 session store。</li></ul><hr><h2 id=後端go>後端（Go）</h2><blockquote><p>使用社群穩定的 WebAuthn 套件，快速把 ceremony 跑起來。
以下程式以 <strong><code>github.com/go-webauthn/webauthn/webauthn</code></strong> 為例。</p></blockquote><blockquote><p>需要 Go 1.20+（建議 1.21/1.22）。
執行前先：<code>go mod init passkey-mvp && go get github.com/go-webauthn/webauthn/webauthn github.com/go-webauthn/webauthn/protocol</code></p></blockquote><p><strong>檔案：<code>main.go</code></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=ln>  1</span><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=ln>  2</span><span class=cl>
</span></span><span class=line><span class=ln>  3</span><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=ln>  4</span><span class=cl>	<span class=s>&#34;crypto/rand&#34;</span>
</span></span><span class=line><span class=ln>  5</span><span class=cl>	<span class=s>&#34;encoding/base64&#34;</span>
</span></span><span class=line><span class=ln>  6</span><span class=cl>	<span class=s>&#34;encoding/json&#34;</span>
</span></span><span class=line><span class=ln>  7</span><span class=cl>	<span class=s>&#34;log&#34;</span>
</span></span><span class=line><span class=ln>  8</span><span class=cl>	<span class=s>&#34;net/http&#34;</span>
</span></span><span class=line><span class=ln>  9</span><span class=cl>	<span class=s>&#34;sync&#34;</span>
</span></span><span class=line><span class=ln> 10</span><span class=cl>	<span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=ln> 11</span><span class=cl>
</span></span><span class=line><span class=ln> 12</span><span class=cl>	<span class=s>&#34;github.com/go-webauthn/webauthn/protocol&#34;</span>
</span></span><span class=line><span class=ln> 13</span><span class=cl>	<span class=s>&#34;github.com/go-webauthn/webauthn/webauthn&#34;</span>
</span></span><span class=line><span class=ln> 14</span><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=ln> 15</span><span class=cl>
</span></span><span class=line><span class=ln> 16</span><span class=cl><span class=c1>// ===== In-memory 模擬儲存 =====</span>
</span></span><span class=line><span class=ln> 17</span><span class=cl>
</span></span><span class=line><span class=ln> 18</span><span class=cl><span class=kd>type</span> <span class=nx>User</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 19</span><span class=cl>	<span class=nx>ID</span>          <span class=kt>uint64</span>
</span></span><span class=line><span class=ln> 20</span><span class=cl>	<span class=nx>Name</span>        <span class=kt>string</span>
</span></span><span class=line><span class=ln> 21</span><span class=cl>	<span class=nx>DisplayName</span> <span class=kt>string</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>	<span class=nx>Credentials</span> <span class=p>[]</span><span class=nx>webauthn</span><span class=p>.</span><span class=nx>Credential</span>
</span></span><span class=line><span class=ln> 23</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 24</span><span class=cl>
</span></span><span class=line><span class=ln> 25</span><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>WebAuthnID</span><span class=p>()</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 26</span><span class=cl>	<span class=nx>b</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=mi>8</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 27</span><span class=cl>	<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=p>&lt;</span> <span class=mi>8</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>		<span class=nx>b</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nb>byte</span><span class=p>((</span><span class=nx>u</span><span class=p>.</span><span class=nx>ID</span> <span class=o>&gt;&gt;</span> <span class=p>(</span><span class=mi>8</span> <span class=o>*</span> <span class=nx>i</span><span class=p>))</span> <span class=o>&amp;</span> <span class=mh>0xff</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 29</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln> 30</span><span class=cl>	<span class=k>return</span> <span class=nx>b</span>
</span></span><span class=line><span class=ln> 31</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 32</span><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>WebAuthnName</span><span class=p>()</span> <span class=kt>string</span>        <span class=p>{</span> <span class=k>return</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Name</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 33</span><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>WebAuthnDisplayName</span><span class=p>()</span> <span class=kt>string</span> <span class=p>{</span> <span class=k>return</span> <span class=nx>u</span><span class=p>.</span><span class=nx>DisplayName</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 34</span><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>WebAuthnIcon</span><span class=p>()</span> <span class=kt>string</span>        <span class=p>{</span> <span class=k>return</span> <span class=s>&#34;&#34;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 35</span><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>u</span> <span class=o>*</span><span class=nx>User</span><span class=p>)</span> <span class=nf>WebAuthnCredentials</span><span class=p>()</span> <span class=p>[]</span><span class=nx>webauthn</span><span class=p>.</span><span class=nx>Credential</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 36</span><span class=cl>	<span class=k>return</span> <span class=nx>u</span><span class=p>.</span><span class=nx>Credentials</span>
</span></span><span class=line><span class=ln> 37</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 38</span><span class=cl>
</span></span><span class=line><span class=ln> 39</span><span class=cl><span class=kd>var</span> <span class=p>(</span>
</span></span><span class=line><span class=ln> 40</span><span class=cl>	<span class=nx>usersMu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=ln> 41</span><span class=cl>	<span class=nx>users</span>   <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>User</span><span class=p>{}</span> <span class=c1>// key = username</span>
</span></span><span class=line><span class=ln> 42</span><span class=cl>	<span class=nx>nextID</span>  <span class=kt>uint64</span> <span class=p>=</span> <span class=mi>1</span>
</span></span><span class=line><span class=ln> 43</span><span class=cl>
</span></span><span class=line><span class=ln> 44</span><span class=cl>	<span class=c1>// 每個 session id 對應 WebAuthn 的暫存資料</span>
</span></span><span class=line><span class=ln> 45</span><span class=cl>	<span class=nx>sessionMu</span> <span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span>
</span></span><span class=line><span class=ln> 46</span><span class=cl>	<span class=nx>regSess</span>   <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>webauthn</span><span class=p>.</span><span class=nx>SessionData</span><span class=p>{}</span> <span class=c1>// registration session</span>
</span></span><span class=line><span class=ln> 47</span><span class=cl>	<span class=nx>authSess</span>  <span class=p>=</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=o>*</span><span class=nx>webauthn</span><span class=p>.</span><span class=nx>SessionData</span><span class=p>{}</span> <span class=c1>// authentication session</span>
</span></span><span class=line><span class=ln> 48</span><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=ln> 49</span><span class=cl>
</span></span><span class=line><span class=ln> 50</span><span class=cl><span class=kd>func</span> <span class=nf>getOrCreateUser</span><span class=p>(</span><span class=nx>username</span> <span class=kt>string</span><span class=p>)</span> <span class=o>*</span><span class=nx>User</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 51</span><span class=cl>	<span class=nx>usersMu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 52</span><span class=cl>	<span class=k>defer</span> <span class=nx>usersMu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=ln> 53</span><span class=cl>	<span class=k>if</span> <span class=nx>u</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>users</span><span class=p>[</span><span class=nx>username</span><span class=p>];</span> <span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl>		<span class=k>return</span> <span class=nx>u</span>
</span></span><span class=line><span class=ln> 55</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln> 56</span><span class=cl>	<span class=nx>u</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>User</span><span class=p>{</span>
</span></span><span class=line><span class=ln> 57</span><span class=cl>		<span class=nx>ID</span><span class=p>:</span>          <span class=nx>nextID</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 58</span><span class=cl>		<span class=nx>Name</span><span class=p>:</span>        <span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 59</span><span class=cl>		<span class=nx>DisplayName</span><span class=p>:</span> <span class=nx>username</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 60</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln> 61</span><span class=cl>	<span class=nx>nextID</span><span class=o>++</span>
</span></span><span class=line><span class=ln> 62</span><span class=cl>	<span class=nx>users</span><span class=p>[</span><span class=nx>username</span><span class=p>]</span> <span class=p>=</span> <span class=nx>u</span>
</span></span><span class=line><span class=ln> 63</span><span class=cl>	<span class=k>return</span> <span class=nx>u</span>
</span></span><span class=line><span class=ln> 64</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 65</span><span class=cl>
</span></span><span class=line><span class=ln> 66</span><span class=cl><span class=kd>func</span> <span class=nf>setCookie</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>name</span><span class=p>,</span> <span class=nx>val</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 67</span><span class=cl>	<span class=nx>http</span><span class=p>.</span><span class=nf>SetCookie</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>http</span><span class=p>.</span><span class=nx>Cookie</span><span class=p>{</span>
</span></span><span class=line><span class=ln> 68</span><span class=cl>		<span class=nx>Name</span><span class=p>:</span>     <span class=nx>name</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 69</span><span class=cl>		<span class=nx>Value</span><span class=p>:</span>    <span class=nx>val</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 70</span><span class=cl>		<span class=nx>Path</span><span class=p>:</span>     <span class=s>&#34;/&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 71</span><span class=cl>		<span class=nx>HttpOnly</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 72</span><span class=cl>		<span class=nx>SameSite</span><span class=p>:</span> <span class=nx>http</span><span class=p>.</span><span class=nx>SameSiteLaxMode</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 73</span><span class=cl>		<span class=nx>Expires</span><span class=p>:</span>  <span class=nx>time</span><span class=p>.</span><span class=nf>Now</span><span class=p>().</span><span class=nf>Add</span><span class=p>(</span><span class=mi>15</span> <span class=o>*</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Minute</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 74</span><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 76</span><span class=cl>
</span></span><span class=line><span class=ln> 77</span><span class=cl><span class=kd>func</span> <span class=nf>getCookie</span><span class=p>(</span><span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>,</span> <span class=nx>name</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 78</span><span class=cl>	<span class=nx>c</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nf>Cookie</span><span class=p>(</span><span class=nx>name</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 79</span><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>		<span class=k>return</span> <span class=s>&#34;&#34;</span>
</span></span><span class=line><span class=ln> 81</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln> 82</span><span class=cl>	<span class=k>return</span> <span class=nx>c</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=ln> 83</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 84</span><span class=cl>
</span></span><span class=line><span class=ln> 85</span><span class=cl><span class=c1>// ===== WebAuthn 物件 =====</span>
</span></span><span class=line><span class=ln> 86</span><span class=cl>
</span></span><span class=line><span class=ln> 87</span><span class=cl><span class=kd>var</span> <span class=nx>webAuthn</span> <span class=o>*</span><span class=nx>webauthn</span><span class=p>.</span><span class=nx>WebAuthn</span>
</span></span><span class=line><span class=ln> 88</span><span class=cl>
</span></span><span class=line><span class=ln> 89</span><span class=cl><span class=kd>func</span> <span class=nf>mustInitWebAuthn</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 90</span><span class=cl>	<span class=kd>var</span> <span class=nx>err</span> <span class=kt>error</span>
</span></span><span class=line><span class=ln> 91</span><span class=cl>	<span class=nx>webAuthn</span><span class=p>,</span> <span class=nx>err</span> <span class=p>=</span> <span class=nx>webauthn</span><span class=p>.</span><span class=nf>New</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>webauthn</span><span class=p>.</span><span class=nx>Config</span><span class=p>{</span>
</span></span><span class=line><span class=ln> 92</span><span class=cl>		<span class=nx>RPDisplayName</span><span class=p>:</span> <span class=s>&#34;Passkey MVP&#34;</span><span class=p>,</span>       <span class=c1>// RP 顯示名稱</span>
</span></span><span class=line><span class=ln> 93</span><span class=cl>		<span class=nx>RPID</span><span class=p>:</span>          <span class=s>&#34;localhost&#34;</span><span class=p>,</span>         <span class=c1>// RP ID（要和網域相符）</span>
</span></span><span class=line><span class=ln> 94</span><span class=cl>		<span class=nx>RPOrigins</span><span class=p>:</span>     <span class=p>[]</span><span class=kt>string</span><span class=p>{</span><span class=s>&#34;http://localhost:8080&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln> 95</span><span class=cl>	<span class=p>})</span>
</span></span><span class=line><span class=ln> 96</span><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 97</span><span class=cl>		<span class=nx>log</span><span class=p>.</span><span class=nf>Fatalf</span><span class=p>(</span><span class=s>&#34;webauthn init error: %v&#34;</span><span class=p>,</span> <span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 98</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln> 99</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>100</span><span class=cl>
</span></span><span class=line><span class=ln>101</span><span class=cl><span class=c1>// ===== Util =====</span>
</span></span><span class=line><span class=ln>102</span><span class=cl>
</span></span><span class=line><span class=ln>103</span><span class=cl><span class=kd>func</span> <span class=nf>randomB64</span><span class=p>(</span><span class=nx>n</span> <span class=kt>int</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>104</span><span class=cl>	<span class=nx>b</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>byte</span><span class=p>,</span> <span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=ln>105</span><span class=cl>	<span class=k>if</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>rand</span><span class=p>.</span><span class=nf>Read</span><span class=p>(</span><span class=nx>b</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>106</span><span class=cl>		<span class=nb>panic</span><span class=p>(</span><span class=nx>err</span><span class=p>)</span>
</span></span><span class=line><span class=ln>107</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>108</span><span class=cl>	<span class=k>return</span> <span class=nx>base64</span><span class=p>.</span><span class=nx>RawURLEncoding</span><span class=p>.</span><span class=nf>EncodeToString</span><span class=p>(</span><span class=nx>b</span><span class=p>)</span>
</span></span><span class=line><span class=ln>109</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>110</span><span class=cl>
</span></span><span class=line><span class=ln>111</span><span class=cl><span class=c1>// ===== Handlers =====</span>
</span></span><span class=line><span class=ln>112</span><span class=cl>
</span></span><span class=line><span class=ln>113</span><span class=cl><span class=kd>type</span> <span class=nx>startRegisterReq</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>114</span><span class=cl>	<span class=nx>Username</span> <span class=kt>string</span> <span class=s>`json:&#34;username&#34;`</span>
</span></span><span class=line><span class=ln>115</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>116</span><span class=cl>
</span></span><span class=line><span class=ln>117</span><span class=cl><span class=kd>func</span> <span class=nf>handleRegisterStart</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>118</span><span class=cl>	<span class=c1>// 1) 前端傳 username；在真實系統會有登入或帳號建立流程</span>
</span></span><span class=line><span class=ln>119</span><span class=cl>	<span class=kd>var</span> <span class=nx>req</span> <span class=nx>startRegisterReq</span>
</span></span><span class=line><span class=ln>120</span><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>req</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Username</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>121</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;bad request&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=ln>122</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>123</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>124</span><span class=cl>	<span class=nx>user</span> <span class=o>:=</span> <span class=nf>getOrCreateUser</span><span class=p>(</span><span class=nx>req</span><span class=p>.</span><span class=nx>Username</span><span class=p>)</span>
</span></span><span class=line><span class=ln>125</span><span class=cl>
</span></span><span class=line><span class=ln>126</span><span class=cl>	<span class=c1>// 2) BeginRegistration：產生 PublicKeyCredentialCreationOptions + SessionData</span>
</span></span><span class=line><span class=ln>127</span><span class=cl>	<span class=nx>opts</span><span class=p>,</span> <span class=nx>sessionData</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>webAuthn</span><span class=p>.</span><span class=nf>BeginRegistration</span><span class=p>(</span>
</span></span><span class=line><span class=ln>128</span><span class=cl>		<span class=nx>user</span><span class=p>,</span>
</span></span><span class=line><span class=ln>129</span><span class=cl>		<span class=nx>webauthn</span><span class=p>.</span><span class=nf>WithAuthenticatorSelection</span><span class=p>(</span><span class=nx>protocol</span><span class=p>.</span><span class=nx>AuthenticatorSelection</span><span class=p>{</span>
</span></span><span class=line><span class=ln>130</span><span class=cl>			<span class=nx>RequireResidentKey</span><span class=p>:</span> <span class=nx>protocol</span><span class=p>.</span><span class=nf>ResidentKeyRequired</span><span class=p>(),</span>
</span></span><span class=line><span class=ln>131</span><span class=cl>			<span class=nx>UserVerification</span><span class=p>:</span>   <span class=nx>protocol</span><span class=p>.</span><span class=nx>VerificationPreferred</span><span class=p>,</span> <span class=c1>// UV 建議 Preferred / Required 視需求</span>
</span></span><span class=line><span class=ln>132</span><span class=cl>		<span class=p>}),</span>
</span></span><span class=line><span class=ln>133</span><span class=cl>	<span class=p>)</span>
</span></span><span class=line><span class=ln>134</span><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>135</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;begin registration error: &#34;</span><span class=o>+</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=ln>136</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>137</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>138</span><span class=cl>
</span></span><span class=line><span class=ln>139</span><span class=cl>	<span class=c1>// 3) 建一個 sid 對應 SessionData，寫入 cookie</span>
</span></span><span class=line><span class=ln>140</span><span class=cl>	<span class=nx>sid</span> <span class=o>:=</span> <span class=nf>randomB64</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=ln>141</span><span class=cl>	<span class=nx>sessionMu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=ln>142</span><span class=cl>	<span class=nx>regSess</span><span class=p>[</span><span class=nx>sid</span><span class=p>]</span> <span class=p>=</span> <span class=nx>sessionData</span>
</span></span><span class=line><span class=ln>143</span><span class=cl>	<span class=nx>sessionMu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=ln>144</span><span class=cl>	<span class=nf>setCookie</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;sid&#34;</span><span class=p>,</span> <span class=nx>sid</span><span class=p>)</span>
</span></span><span class=line><span class=ln>145</span><span class=cl>
</span></span><span class=line><span class=ln>146</span><span class=cl>	<span class=c1>// 4) 回傳 options 給前端做 navigator.credentials.create()</span>
</span></span><span class=line><span class=ln>147</span><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>148</span><span class=cl>	<span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>opts</span><span class=p>)</span>
</span></span><span class=line><span class=ln>149</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>150</span><span class=cl>
</span></span><span class=line><span class=ln>151</span><span class=cl><span class=kd>func</span> <span class=nf>handleRegisterFinish</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>152</span><span class=cl>	<span class=nx>username</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nf>Query</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>153</span><span class=cl>	<span class=k>if</span> <span class=nx>username</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>154</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;username required&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=ln>155</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>156</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>157</span><span class=cl>	<span class=nx>user</span> <span class=o>:=</span> <span class=nf>getOrCreateUser</span><span class=p>(</span><span class=nx>username</span><span class=p>)</span>
</span></span><span class=line><span class=ln>158</span><span class=cl>
</span></span><span class=line><span class=ln>159</span><span class=cl>	<span class=nx>sid</span> <span class=o>:=</span> <span class=nf>getCookie</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=s>&#34;sid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>160</span><span class=cl>	<span class=k>if</span> <span class=nx>sid</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>161</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;missing sid&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>)</span>
</span></span><span class=line><span class=ln>162</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>163</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>164</span><span class=cl>	<span class=nx>sessionMu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=ln>165</span><span class=cl>	<span class=nx>sessionData</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>regSess</span><span class=p>[</span><span class=nx>sid</span><span class=p>]</span>
</span></span><span class=line><span class=ln>166</span><span class=cl>	<span class=nb>delete</span><span class=p>(</span><span class=nx>regSess</span><span class=p>,</span> <span class=nx>sid</span><span class=p>)</span> <span class=c1>// 一次性</span>
</span></span><span class=line><span class=ln>167</span><span class=cl>	<span class=nx>sessionMu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=ln>168</span><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>169</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;session not found&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>)</span>
</span></span><span class=line><span class=ln>170</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>171</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>172</span><span class=cl>
</span></span><span class=line><span class=ln>173</span><span class=cl>	<span class=c1>// 讓套件從 request 解析前端傳來的 attestation response，完成註冊</span>
</span></span><span class=line><span class=ln>174</span><span class=cl>	<span class=nx>credential</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>webAuthn</span><span class=p>.</span><span class=nf>FinishRegistration</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=o>*</span><span class=nx>sessionData</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=ln>175</span><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>176</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;finish registration error: &#34;</span><span class=o>+</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=ln>177</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>178</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>179</span><span class=cl>
</span></span><span class=line><span class=ln>180</span><span class=cl>	<span class=c1>// 把 Credential 存到使用者</span>
</span></span><span class=line><span class=ln>181</span><span class=cl>	<span class=nx>usersMu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=ln>182</span><span class=cl>	<span class=nx>user</span><span class=p>.</span><span class=nx>Credentials</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Credentials</span><span class=p>,</span> <span class=o>*</span><span class=nx>credential</span><span class=p>)</span>
</span></span><span class=line><span class=ln>183</span><span class=cl>	<span class=nx>usersMu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=ln>184</span><span class=cl>
</span></span><span class=line><span class=ln>185</span><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>186</span><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>`{&#34;ok&#34;:true}`</span><span class=p>))</span>
</span></span><span class=line><span class=ln>187</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>188</span><span class=cl>
</span></span><span class=line><span class=ln>189</span><span class=cl><span class=kd>type</span> <span class=nx>startLoginReq</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>190</span><span class=cl>	<span class=nx>Username</span> <span class=kt>string</span> <span class=s>`json:&#34;username&#34;`</span>
</span></span><span class=line><span class=ln>191</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>192</span><span class=cl>
</span></span><span class=line><span class=ln>193</span><span class=cl><span class=kd>func</span> <span class=nf>handleLoginStart</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>194</span><span class=cl>	<span class=kd>var</span> <span class=nx>req</span> <span class=nx>startLoginReq</span>
</span></span><span class=line><span class=ln>195</span><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>json</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>.</span><span class=nx>Body</span><span class=p>).</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>req</span><span class=p>);</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>req</span><span class=p>.</span><span class=nx>Username</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>196</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;bad request&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=ln>197</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>198</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>199</span><span class=cl>	<span class=nx>user</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>users</span><span class=p>[</span><span class=nx>req</span><span class=p>.</span><span class=nx>Username</span><span class=p>]</span>
</span></span><span class=line><span class=ln>200</span><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=o>||</span> <span class=nb>len</span><span class=p>(</span><span class=nx>user</span><span class=p>.</span><span class=nx>Credentials</span><span class=p>)</span> <span class=o>==</span> <span class=mi>0</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>201</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;user not found or no credentials&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusNotFound</span><span class=p>)</span>
</span></span><span class=line><span class=ln>202</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>203</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>204</span><span class=cl>
</span></span><span class=line><span class=ln>205</span><span class=cl>	<span class=c1>// 產生 PublicKeyCredentialRequestOptions + SessionData</span>
</span></span><span class=line><span class=ln>206</span><span class=cl>	<span class=nx>opts</span><span class=p>,</span> <span class=nx>sessionData</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>webAuthn</span><span class=p>.</span><span class=nf>BeginLogin</span><span class=p>(</span><span class=nx>user</span><span class=p>)</span>
</span></span><span class=line><span class=ln>207</span><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>208</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;begin login error: &#34;</span><span class=o>+</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusInternalServerError</span><span class=p>)</span>
</span></span><span class=line><span class=ln>209</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>210</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>211</span><span class=cl>
</span></span><span class=line><span class=ln>212</span><span class=cl>	<span class=c1>// 存 session</span>
</span></span><span class=line><span class=ln>213</span><span class=cl>	<span class=nx>sid</span> <span class=o>:=</span> <span class=nf>randomB64</span><span class=p>(</span><span class=mi>16</span><span class=p>)</span>
</span></span><span class=line><span class=ln>214</span><span class=cl>	<span class=nx>sessionMu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=ln>215</span><span class=cl>	<span class=nx>authSess</span><span class=p>[</span><span class=nx>sid</span><span class=p>]</span> <span class=p>=</span> <span class=nx>sessionData</span>
</span></span><span class=line><span class=ln>216</span><span class=cl>	<span class=nx>sessionMu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=ln>217</span><span class=cl>	<span class=nf>setCookie</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;sid&#34;</span><span class=p>,</span> <span class=nx>sid</span><span class=p>)</span>
</span></span><span class=line><span class=ln>218</span><span class=cl>
</span></span><span class=line><span class=ln>219</span><span class=cl>	<span class=c1>// 傳給前端做 navigator.credentials.get()</span>
</span></span><span class=line><span class=ln>220</span><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>221</span><span class=cl>	<span class=nx>json</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>).</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>opts</span><span class=p>)</span>
</span></span><span class=line><span class=ln>222</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>223</span><span class=cl>
</span></span><span class=line><span class=ln>224</span><span class=cl><span class=kd>func</span> <span class=nf>handleLoginFinish</span><span class=p>(</span><span class=nx>w</span> <span class=nx>http</span><span class=p>.</span><span class=nx>ResponseWriter</span><span class=p>,</span> <span class=nx>r</span> <span class=o>*</span><span class=nx>http</span><span class=p>.</span><span class=nx>Request</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>225</span><span class=cl>	<span class=nx>username</span> <span class=o>:=</span> <span class=nx>r</span><span class=p>.</span><span class=nx>URL</span><span class=p>.</span><span class=nf>Query</span><span class=p>().</span><span class=nf>Get</span><span class=p>(</span><span class=s>&#34;username&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>226</span><span class=cl>	<span class=k>if</span> <span class=nx>username</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>227</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;username required&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=ln>228</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>229</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>230</span><span class=cl>	<span class=nx>user</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>users</span><span class=p>[</span><span class=nx>username</span><span class=p>]</span>
</span></span><span class=line><span class=ln>231</span><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>232</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;user not found&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusNotFound</span><span class=p>)</span>
</span></span><span class=line><span class=ln>233</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>234</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>235</span><span class=cl>
</span></span><span class=line><span class=ln>236</span><span class=cl>	<span class=nx>sid</span> <span class=o>:=</span> <span class=nf>getCookie</span><span class=p>(</span><span class=nx>r</span><span class=p>,</span> <span class=s>&#34;sid&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>237</span><span class=cl>	<span class=k>if</span> <span class=nx>sid</span> <span class=o>==</span> <span class=s>&#34;&#34;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>238</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;missing sid&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>)</span>
</span></span><span class=line><span class=ln>239</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>240</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>241</span><span class=cl>	<span class=nx>sessionMu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=ln>242</span><span class=cl>	<span class=nx>sessionData</span><span class=p>,</span> <span class=nx>ok</span> <span class=o>:=</span> <span class=nx>authSess</span><span class=p>[</span><span class=nx>sid</span><span class=p>]</span>
</span></span><span class=line><span class=ln>243</span><span class=cl>	<span class=nb>delete</span><span class=p>(</span><span class=nx>authSess</span><span class=p>,</span> <span class=nx>sid</span><span class=p>)</span>
</span></span><span class=line><span class=ln>244</span><span class=cl>	<span class=nx>sessionMu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=ln>245</span><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>ok</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>246</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;session not found&#34;</span><span class=p>,</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusUnauthorized</span><span class=p>)</span>
</span></span><span class=line><span class=ln>247</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>248</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>249</span><span class=cl>
</span></span><span class=line><span class=ln>250</span><span class=cl>	<span class=c1>// 解析 assertion response，驗證簽章 + 更新 sign counter</span>
</span></span><span class=line><span class=ln>251</span><span class=cl>	<span class=nx>_</span><span class=p>,</span> <span class=nx>err</span> <span class=o>:=</span> <span class=nx>webAuthn</span><span class=p>.</span><span class=nf>FinishLogin</span><span class=p>(</span><span class=nx>user</span><span class=p>,</span> <span class=o>*</span><span class=nx>sessionData</span><span class=p>,</span> <span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=ln>252</span><span class=cl>	<span class=k>if</span> <span class=nx>err</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>253</span><span class=cl>		<span class=nx>http</span><span class=p>.</span><span class=nf>Error</span><span class=p>(</span><span class=nx>w</span><span class=p>,</span> <span class=s>&#34;finish login error: &#34;</span><span class=o>+</span><span class=nx>err</span><span class=p>.</span><span class=nf>Error</span><span class=p>(),</span> <span class=nx>http</span><span class=p>.</span><span class=nx>StatusBadRequest</span><span class=p>)</span>
</span></span><span class=line><span class=ln>254</span><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=ln>255</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>256</span><span class=cl>
</span></span><span class=line><span class=ln>257</span><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>Header</span><span class=p>().</span><span class=nf>Set</span><span class=p>(</span><span class=s>&#34;Content-Type&#34;</span><span class=p>,</span> <span class=s>&#34;application/json&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>258</span><span class=cl>	<span class=nx>w</span><span class=p>.</span><span class=nf>Write</span><span class=p>([]</span><span class=nb>byte</span><span class=p>(</span><span class=s>`{&#34;ok&#34;:true,&#34;message&#34;:&#34;login success&#34;}`</span><span class=p>))</span>
</span></span><span class=line><span class=ln>259</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>260</span><span class=cl>
</span></span><span class=line><span class=ln>261</span><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>262</span><span class=cl>	<span class=nf>mustInitWebAuthn</span><span class=p>()</span>
</span></span><span class=line><span class=ln>263</span><span class=cl>
</span></span><span class=line><span class=ln>264</span><span class=cl>	<span class=c1>// 靜態頁面</span>
</span></span><span class=line><span class=ln>265</span><span class=cl>	<span class=nx>fs</span> <span class=o>:=</span> <span class=nx>http</span><span class=p>.</span><span class=nf>FileServer</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>Dir</span><span class=p>(</span><span class=s>&#34;./public&#34;</span><span class=p>))</span>
</span></span><span class=line><span class=ln>266</span><span class=cl>	<span class=nx>http</span><span class=p>.</span><span class=nf>Handle</span><span class=p>(</span><span class=s>&#34;/&#34;</span><span class=p>,</span> <span class=nx>fs</span><span class=p>)</span>
</span></span><span class=line><span class=ln>267</span><span class=cl>
</span></span><span class=line><span class=ln>268</span><span class=cl>	<span class=c1>// API</span>
</span></span><span class=line><span class=ln>269</span><span class=cl>	<span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/api/register/start&#34;</span><span class=p>,</span> <span class=nx>handleRegisterStart</span><span class=p>)</span>
</span></span><span class=line><span class=ln>270</span><span class=cl>	<span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/api/register/finish&#34;</span><span class=p>,</span> <span class=nx>handleRegisterFinish</span><span class=p>)</span>
</span></span><span class=line><span class=ln>271</span><span class=cl>	<span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/api/login/start&#34;</span><span class=p>,</span> <span class=nx>handleLoginStart</span><span class=p>)</span>
</span></span><span class=line><span class=ln>272</span><span class=cl>	<span class=nx>http</span><span class=p>.</span><span class=nf>HandleFunc</span><span class=p>(</span><span class=s>&#34;/api/login/finish&#34;</span><span class=p>,</span> <span class=nx>handleLoginFinish</span><span class=p>)</span>
</span></span><span class=line><span class=ln>273</span><span class=cl>
</span></span><span class=line><span class=ln>274</span><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;listening on http://localhost:8080&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>275</span><span class=cl>	<span class=nx>log</span><span class=p>.</span><span class=nf>Fatal</span><span class=p>(</span><span class=nx>http</span><span class=p>.</span><span class=nf>ListenAndServe</span><span class=p>(</span><span class=s>&#34;:8080&#34;</span><span class=p>,</span> <span class=kc>nil</span><span class=p>))</span>
</span></span><span class=line><span class=ln>276</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><hr><h2 id=前端html--css--js>前端（HTML + CSS + JS）</h2><blockquote><p>純原生 API；負責把後端提供的 options 轉成 <code>ArrayBuffer</code> / <code>Base64URL</code> 所需型別，並把 browser 產生的憑證送回 server。</p></blockquote><p><strong>檔案：<code>public/index.html</code></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-html data-lang=html><span class=line><span class=ln> 1</span><span class=cl><span class=cp>&lt;!doctype html&gt;</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=p>&lt;</span><span class=nt>html</span> <span class=na>lang</span><span class=o>=</span><span class=s>&#34;zh-Hant&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=p>&lt;</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>charset</span><span class=o>=</span><span class=s>&#34;utf-8&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>  <span class=p>&lt;</span><span class=nt>meta</span> <span class=na>name</span><span class=o>=</span><span class=s>&#34;viewport&#34;</span> <span class=na>content</span><span class=o>=</span><span class=s>&#34;width=device-width, initial-scale=1&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=p>&lt;</span><span class=nt>title</span><span class=p>&gt;</span>Passkey MVP<span class=p>&lt;/</span><span class=nt>title</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=p>&lt;</span><span class=nt>link</span> <span class=na>rel</span><span class=o>=</span><span class=s>&#34;stylesheet&#34;</span> <span class=na>href</span><span class=o>=</span><span class=s>&#34;/style.css&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=p>&lt;/</span><span class=nt>head</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=p>&lt;</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>  <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;container&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=p>&lt;</span><span class=nt>h1</span><span class=p>&gt;</span>Passkey MVP<span class=p>&lt;/</span><span class=nt>h1</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=p>&lt;</span><span class=nt>p</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;hint&#34;</span><span class=p>&gt;</span>請在支援 WebAuthn 的瀏覽器上測試（Chrome、Edge、Safari 近版）。<span class=p>&lt;/</span><span class=nt>p</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=p>&lt;</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>      <span class=p>&lt;</span><span class=nt>span</span><span class=p>&gt;</span>使用者名稱<span class=p>&lt;/</span><span class=nt>span</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>      <span class=p>&lt;</span><span class=nt>input</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;username&#34;</span> <span class=na>placeholder</span><span class=o>=</span><span class=s>&#34;alice&#34;</span> <span class=na>value</span><span class=o>=</span><span class=s>&#34;alice&#34;</span> <span class=p>/&gt;</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=p>&lt;/</span><span class=nt>label</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=p>&lt;</span><span class=nt>div</span> <span class=na>class</span><span class=o>=</span><span class=s>&#34;actions&#34;</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>      <span class=p>&lt;</span><span class=nt>button</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;btnReg&#34;</span><span class=p>&gt;</span>註冊 Passkey<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>      <span class=p>&lt;</span><span class=nt>button</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;btnLogin&#34;</span><span class=p>&gt;</span>使用 Passkey 登入<span class=p>&lt;/</span><span class=nt>button</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>    <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>
</span></span><span class=line><span class=ln>24</span><span class=cl>    <span class=p>&lt;</span><span class=nt>pre</span> <span class=na>id</span><span class=o>=</span><span class=s>&#34;log&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>pre</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>  <span class=p>&lt;/</span><span class=nt>div</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>
</span></span><span class=line><span class=ln>27</span><span class=cl>  <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/utils.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>  <span class=p>&lt;</span><span class=nt>script</span> <span class=na>src</span><span class=o>=</span><span class=s>&#34;/web.js&#34;</span><span class=p>&gt;&lt;/</span><span class=nt>script</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>29</span><span class=cl><span class=p>&lt;/</span><span class=nt>body</span><span class=p>&gt;</span>
</span></span><span class=line><span class=ln>30</span><span class=cl><span class=p>&lt;/</span><span class=nt>html</span><span class=p>&gt;</span>
</span></span></code></pre></div><p><strong>檔案：<code>public/style.css</code></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-css data-lang=css><span class=line><span class=ln> 1</span><span class=cl><span class=o>*</span> <span class=p>{</span> <span class=k>box-sizing</span><span class=p>:</span> <span class=kc>border-box</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=nt>body</span> <span class=p>{</span> <span class=k>margin</span><span class=p>:</span> <span class=mi>0</span><span class=p>;</span> <span class=k>font-family</span><span class=p>:</span> <span class=n>ui-sans-serif</span><span class=p>,</span> <span class=n>system-ui</span><span class=p>,</span> <span class=o>-</span><span class=n>apple-system</span><span class=p>,</span> <span class=s2>&#34;Segoe UI&#34;</span><span class=p>,</span> <span class=n>Roboto</span><span class=p>,</span> <span class=s2>&#34;Noto Sans&#34;</span><span class=p>,</span> <span class=s2>&#34;PingFang TC&#34;</span><span class=p>,</span> <span class=s2>&#34;Microsoft JhengHei&#34;</span><span class=p>,</span> <span class=kc>sans-serif</span><span class=p>;</span> <span class=k>background</span><span class=p>:</span> <span class=mh>#0b1020</span><span class=p>;</span> <span class=k>color</span><span class=p>:</span> <span class=mh>#e6eefc</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=p>.</span><span class=nc>container</span> <span class=p>{</span> <span class=k>max-width</span><span class=p>:</span> <span class=mi>760</span><span class=kt>px</span><span class=p>;</span> <span class=k>margin</span><span class=p>:</span> <span class=mi>40</span><span class=kt>px</span> <span class=kc>auto</span><span class=p>;</span> <span class=k>padding</span><span class=p>:</span> <span class=mi>24</span><span class=kt>px</span><span class=p>;</span> <span class=k>background</span><span class=p>:</span> <span class=mh>#0f1530</span><span class=p>;</span> <span class=k>border</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=kc>solid</span> <span class=mh>#1f2750</span><span class=p>;</span> <span class=k>border-radius</span><span class=p>:</span> <span class=mi>16</span><span class=kt>px</span><span class=p>;</span> <span class=k>box-shadow</span><span class=p>:</span> <span class=mi>0</span> <span class=mi>10</span><span class=kt>px</span> <span class=mi>30</span><span class=kt>px</span> <span class=nb>rgba</span><span class=p>(</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mf>.35</span><span class=p>);</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=nt>h1</span> <span class=p>{</span> <span class=k>margin</span><span class=p>:</span> <span class=mi>0</span> <span class=mi>0</span> <span class=mi>8</span><span class=kt>px</span><span class=p>;</span> <span class=k>font-size</span><span class=p>:</span> <span class=mi>28</span><span class=kt>px</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=p>.</span><span class=nc>hint</span> <span class=p>{</span> <span class=k>opacity</span><span class=p>:</span> <span class=mf>.8</span><span class=p>;</span> <span class=k>margin</span><span class=p>:</span> <span class=mi>0</span> <span class=mi>0</span> <span class=mi>16</span><span class=kt>px</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=nt>label</span> <span class=p>{</span> <span class=k>display</span><span class=p>:</span> <span class=kc>block</span><span class=p>;</span> <span class=k>margin</span><span class=p>:</span> <span class=mi>12</span><span class=kt>px</span> <span class=mi>0</span> <span class=mi>20</span><span class=kt>px</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=nt>label</span> <span class=nt>span</span> <span class=p>{</span> <span class=k>display</span><span class=p>:</span> <span class=kc>block</span><span class=p>;</span> <span class=k>margin-bottom</span><span class=p>:</span> <span class=mi>6</span><span class=kt>px</span><span class=p>;</span> <span class=k>opacity</span><span class=p>:</span> <span class=mf>.9</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=nt>input</span> <span class=p>{</span> <span class=k>width</span><span class=p>:</span> <span class=mi>100</span><span class=kt>%</span><span class=p>;</span> <span class=k>padding</span><span class=p>:</span> <span class=mi>10</span><span class=kt>px</span> <span class=mi>12</span><span class=kt>px</span><span class=p>;</span> <span class=k>border-radius</span><span class=p>:</span> <span class=mi>10</span><span class=kt>px</span><span class=p>;</span> <span class=k>border</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=kc>solid</span> <span class=mh>#2b3366</span><span class=p>;</span> <span class=k>background</span><span class=p>:</span> <span class=mh>#0b122a</span><span class=p>;</span> <span class=k>color</span><span class=p>:</span> <span class=mh>#e6eefc</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=p>.</span><span class=nc>actions</span> <span class=p>{</span> <span class=k>display</span><span class=p>:</span> <span class=kc>flex</span><span class=p>;</span> <span class=k>gap</span><span class=p>:</span> <span class=mi>12</span><span class=kt>px</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=nt>button</span> <span class=p>{</span> <span class=k>padding</span><span class=p>:</span> <span class=mi>10</span><span class=kt>px</span> <span class=mi>14</span><span class=kt>px</span><span class=p>;</span> <span class=k>border-radius</span><span class=p>:</span> <span class=mi>999</span><span class=kt>px</span><span class=p>;</span> <span class=k>border</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=kc>solid</span> <span class=mh>#2b3366</span><span class=p>;</span> <span class=k>background</span><span class=p>:</span> <span class=mh>#1a2350</span><span class=p>;</span> <span class=k>color</span><span class=p>:</span> <span class=mh>#e6eefc</span><span class=p>;</span> <span class=k>cursor</span><span class=p>:</span> <span class=kc>pointer</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=nt>button</span><span class=p>:</span><span class=nd>hover</span> <span class=p>{</span> <span class=k>background</span><span class=p>:</span> <span class=mh>#223070</span><span class=p>;</span> <span class=p>}</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=nt>pre</span> <span class=p>{</span> <span class=k>margin-top</span><span class=p>:</span> <span class=mi>16</span><span class=kt>px</span><span class=p>;</span> <span class=k>padding</span><span class=p>:</span> <span class=mi>12</span><span class=kt>px</span><span class=p>;</span> <span class=k>background</span><span class=p>:</span> <span class=mh>#0b122a</span><span class=p>;</span> <span class=k>border</span><span class=p>:</span> <span class=mi>1</span><span class=kt>px</span> <span class=kc>solid</span> <span class=mh>#2b3366</span><span class=p>;</span> <span class=k>border-radius</span><span class=p>:</span> <span class=mi>8</span><span class=kt>px</span><span class=p>;</span> <span class=k>overflow</span><span class=p>:</span> <span class=kc>auto</span><span class=p>;</span> <span class=k>min-height</span><span class=p>:</span> <span class=mi>120</span><span class=kt>px</span><span class=p>;</span> <span class=p>}</span>
</span></span></code></pre></div><p><strong>檔案：<code>public/utils.js</code></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// Base64URL &lt;-&gt; ArrayBuffer helpers
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span><span class=kr>const</span> <span class=nx>b64urlToArrayBuffer</span> <span class=o>=</span> <span class=p>(</span><span class=nx>b64url</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=kr>const</span> <span class=nx>pad</span> <span class=o>=</span> <span class=s2>&#34;=&#34;</span><span class=p>.</span><span class=nx>repeat</span><span class=p>((</span><span class=mi>4</span> <span class=o>-</span> <span class=p>(</span><span class=nx>b64url</span><span class=p>.</span><span class=nx>length</span> <span class=o>%</span> <span class=mi>4</span><span class=p>))</span> <span class=o>%</span> <span class=mi>4</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=kr>const</span> <span class=nx>b64</span> <span class=o>=</span> <span class=p>(</span><span class=nx>b64url</span> <span class=o>+</span> <span class=nx>pad</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/-/g</span><span class=p>,</span> <span class=s2>&#34;+&#34;</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/_/g</span><span class=p>,</span> <span class=s2>&#34;/&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>  <span class=kr>const</span> <span class=nx>str</span> <span class=o>=</span> <span class=nx>atob</span><span class=p>(</span><span class=nx>b64</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=kr>const</span> <span class=nx>buf</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>ArrayBuffer</span><span class=p>(</span><span class=nx>str</span><span class=p>.</span><span class=nx>length</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>  <span class=kr>const</span> <span class=nx>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>(</span><span class=nx>buf</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>str</span><span class=p>.</span><span class=nx>length</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=nx>bytes</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=o>=</span> <span class=nx>str</span><span class=p>.</span><span class=nx>charCodeAt</span><span class=p>(</span><span class=nx>i</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=k>return</span> <span class=nx>buf</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=kr>const</span> <span class=nx>arrayBufferToB64url</span> <span class=o>=</span> <span class=p>(</span><span class=nx>buf</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=kr>const</span> <span class=nx>bytes</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>Uint8Array</span><span class=p>(</span><span class=nx>buf</span><span class=p>);</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>  <span class=kd>let</span> <span class=nx>str</span> <span class=o>=</span> <span class=s2>&#34;&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=kd>let</span> <span class=nx>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=nx>i</span> <span class=o>&lt;</span> <span class=nx>bytes</span><span class=p>.</span><span class=nx>byteLength</span><span class=p>;</span> <span class=nx>i</span><span class=o>++</span><span class=p>)</span> <span class=nx>str</span> <span class=o>+=</span> <span class=nb>String</span><span class=p>.</span><span class=nx>fromCharCode</span><span class=p>(</span><span class=nx>bytes</span><span class=p>[</span><span class=nx>i</span><span class=p>]);</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>  <span class=kr>const</span> <span class=nx>b64</span> <span class=o>=</span> <span class=nx>btoa</span><span class=p>(</span><span class=nx>str</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>  <span class=k>return</span> <span class=nx>b64</span><span class=p>.</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/\+/g</span><span class=p>,</span> <span class=s2>&#34;-&#34;</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/\//g</span><span class=p>,</span> <span class=s2>&#34;_&#34;</span><span class=p>).</span><span class=nx>replace</span><span class=p>(</span><span class=sr>/=+$/g</span><span class=p>,</span> <span class=s2>&#34;&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>
</span></span><span class=line><span class=ln>20</span><span class=cl><span class=kr>const</span> <span class=nx>log</span> <span class=o>=</span> <span class=p>(...</span><span class=nx>args</span><span class=p>)</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>  <span class=kr>const</span> <span class=nx>el</span> <span class=o>=</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#log&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>  <span class=nx>el</span><span class=p>.</span><span class=nx>textContent</span> <span class=o>+=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=nx>a</span> <span class=p>=&gt;</span> <span class=p>(</span><span class=k>typeof</span> <span class=nx>a</span> <span class=o>===</span> <span class=s2>&#34;string&#34;</span> <span class=o>?</span> <span class=nx>a</span> <span class=o>:</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>a</span><span class=p>,</span> <span class=kc>null</span><span class=p>,</span> <span class=mi>2</span><span class=p>))).</span><span class=nx>join</span><span class=p>(</span><span class=s2>&#34; &#34;</span><span class=p>)</span> <span class=o>+</span> <span class=s2>&#34;\n&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>23</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>24</span><span class=cl><span class=kr>const</span> <span class=nx>getUsername</span> <span class=o>=</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#username&#34;</span><span class=p>).</span><span class=nx>value</span><span class=p>.</span><span class=nx>trim</span><span class=p>();</span>
</span></span></code></pre></div><p><strong>檔案：<code>public/web.js</code></strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-javascript data-lang=javascript><span class=line><span class=ln>  1</span><span class=cl><span class=kr>async</span> <span class=kd>function</span> <span class=nx>postJSON</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=nx>data</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>  2</span><span class=cl>  <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=nx>url</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>  3</span><span class=cl>    <span class=nx>method</span><span class=o>:</span> <span class=s2>&#34;POST&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>  4</span><span class=cl>    <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span><span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span><span class=s2>&#34;application/json&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln>  5</span><span class=cl>    <span class=nx>body</span><span class=o>:</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>data</span> <span class=o>||</span> <span class=p>{})</span>
</span></span><span class=line><span class=ln>  6</span><span class=cl>  <span class=p>});</span>
</span></span><span class=line><span class=ln>  7</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>res</span><span class=p>.</span><span class=nx>ok</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=sb>`</span><span class=si>${</span><span class=nx>res</span><span class=p>.</span><span class=nx>status</span><span class=si>}</span><span class=sb> </span><span class=si>${</span><span class=kr>await</span> <span class=nx>res</span><span class=p>.</span><span class=nx>text</span><span class=p>()</span><span class=si>}</span><span class=sb>`</span><span class=p>);</span>
</span></span><span class=line><span class=ln>  8</span><span class=cl>  <span class=k>return</span> <span class=nx>res</span><span class=p>.</span><span class=nx>json</span><span class=p>();</span>
</span></span><span class=line><span class=ln>  9</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 10</span><span class=cl>
</span></span><span class=line><span class=ln> 11</span><span class=cl><span class=kd>function</span> <span class=nx>decodeCreationOptions</span><span class=p>(</span><span class=nx>opts</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 12</span><span class=cl>  <span class=c1>// 伺服器傳來的是 JSON（base64url 字串），需轉回 ArrayBuffer
</span></span></span><span class=line><span class=ln> 13</span><span class=cl><span class=c1></span>  <span class=nx>opts</span><span class=p>.</span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>challenge</span> <span class=o>=</span> <span class=nx>b64urlToArrayBuffer</span><span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>challenge</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 14</span><span class=cl>  <span class=nx>opts</span><span class=p>.</span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>b64urlToArrayBuffer</span><span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>user</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 15</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>excludeCredentials</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 16</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>cred</span> <span class=k>of</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>excludeCredentials</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 17</span><span class=cl>      <span class=nx>cred</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>b64urlToArrayBuffer</span><span class=p>(</span><span class=nx>cred</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 18</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 19</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 20</span><span class=cl>  <span class=k>return</span> <span class=nx>opts</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 21</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>
</span></span><span class=line><span class=ln> 23</span><span class=cl><span class=kd>function</span> <span class=nx>decodeRequestOptions</span><span class=p>(</span><span class=nx>opts</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 24</span><span class=cl>  <span class=nx>opts</span><span class=p>.</span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>challenge</span> <span class=o>=</span> <span class=nx>b64urlToArrayBuffer</span><span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>challenge</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 25</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nx>opts</span><span class=p>.</span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>allowCredentials</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 26</span><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kr>const</span> <span class=nx>cred</span> <span class=k>of</span> <span class=nx>opts</span><span class=p>.</span><span class=nx>publicKey</span><span class=p>.</span><span class=nx>allowCredentials</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 27</span><span class=cl>      <span class=nx>cred</span><span class=p>.</span><span class=nx>id</span> <span class=o>=</span> <span class=nx>b64urlToArrayBuffer</span><span class=p>(</span><span class=nx>cred</span><span class=p>.</span><span class=nx>id</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 29</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 30</span><span class=cl>  <span class=k>return</span> <span class=nx>opts</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 31</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 32</span><span class=cl>
</span></span><span class=line><span class=ln> 33</span><span class=cl><span class=kd>function</span> <span class=nx>encodeAttestationResponse</span><span class=p>(</span><span class=nx>cred</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 34</span><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 35</span><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=nx>cred</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 36</span><span class=cl>    <span class=nx>rawId</span><span class=o>:</span> <span class=nx>arrayBufferToB64url</span><span class=p>(</span><span class=nx>cred</span><span class=p>.</span><span class=nx>rawId</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 37</span><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=nx>cred</span><span class=p>.</span><span class=nx>type</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 38</span><span class=cl>    <span class=nx>response</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 39</span><span class=cl>      <span class=nx>clientDataJSON</span><span class=o>:</span> <span class=nx>arrayBufferToB64url</span><span class=p>(</span><span class=nx>cred</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>clientDataJSON</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 40</span><span class=cl>      <span class=nx>attestationObject</span><span class=o>:</span> <span class=nx>arrayBufferToB64url</span><span class=p>(</span><span class=nx>cred</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>attestationObject</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 41</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 42</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln> 43</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 44</span><span class=cl>
</span></span><span class=line><span class=ln> 45</span><span class=cl><span class=kd>function</span> <span class=nx>encodeAssertionResponse</span><span class=p>(</span><span class=nx>cred</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 46</span><span class=cl>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 47</span><span class=cl>    <span class=nx>id</span><span class=o>:</span> <span class=nx>cred</span><span class=p>.</span><span class=nx>id</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 48</span><span class=cl>    <span class=nx>rawId</span><span class=o>:</span> <span class=nx>arrayBufferToB64url</span><span class=p>(</span><span class=nx>cred</span><span class=p>.</span><span class=nx>rawId</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 49</span><span class=cl>    <span class=nx>type</span><span class=o>:</span> <span class=nx>cred</span><span class=p>.</span><span class=nx>type</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 50</span><span class=cl>    <span class=nx>response</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 51</span><span class=cl>      <span class=nx>clientDataJSON</span><span class=o>:</span> <span class=nx>arrayBufferToB64url</span><span class=p>(</span><span class=nx>cred</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>clientDataJSON</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 52</span><span class=cl>      <span class=nx>authenticatorData</span><span class=o>:</span> <span class=nx>arrayBufferToB64url</span><span class=p>(</span><span class=nx>cred</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>authenticatorData</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 53</span><span class=cl>      <span class=nx>signature</span><span class=o>:</span> <span class=nx>arrayBufferToB64url</span><span class=p>(</span><span class=nx>cred</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>signature</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl>      <span class=nx>userHandle</span><span class=o>:</span> <span class=nx>cred</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>userHandle</span> <span class=o>?</span> <span class=nx>arrayBufferToB64url</span><span class=p>(</span><span class=nx>cred</span><span class=p>.</span><span class=nx>response</span><span class=p>.</span><span class=nx>userHandle</span><span class=p>)</span> <span class=o>:</span> <span class=kc>null</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 55</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 56</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln> 57</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 58</span><span class=cl>
</span></span><span class=line><span class=ln> 59</span><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#btnReg&#34;</span><span class=p>).</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 60</span><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 61</span><span class=cl>    <span class=kr>const</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>getUsername</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 62</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>username</span><span class=p>)</span> <span class=k>return</span> <span class=nx>log</span><span class=p>(</span><span class=s2>&#34;請輸入使用者名稱&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 63</span><span class=cl>
</span></span><span class=line><span class=ln> 64</span><span class=cl>    <span class=nx>log</span><span class=p>(</span><span class=s2>&#34;開始註冊：&#34;</span><span class=p>,</span> <span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 65</span><span class=cl>    <span class=kr>const</span> <span class=nx>creationOptions</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>postJSON</span><span class=p>(</span><span class=s2>&#34;/api/register/start&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>username</span> <span class=p>});</span>
</span></span><span class=line><span class=ln> 66</span><span class=cl>    <span class=nx>decodeCreationOptions</span><span class=p>(</span><span class=nx>creationOptions</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 67</span><span class=cl>
</span></span><span class=line><span class=ln> 68</span><span class=cl>    <span class=kr>const</span> <span class=nx>credential</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>navigator</span><span class=p>.</span><span class=nx>credentials</span><span class=p>.</span><span class=nx>create</span><span class=p>(</span><span class=nx>creationOptions</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 69</span><span class=cl>    <span class=nx>log</span><span class=p>(</span><span class=s2>&#34;credential created&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 70</span><span class=cl>
</span></span><span class=line><span class=ln> 71</span><span class=cl>    <span class=kr>const</span> <span class=nx>payload</span> <span class=o>=</span> <span class=nx>encodeAttestationResponse</span><span class=p>(</span><span class=nx>credential</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 72</span><span class=cl>    <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=sb>`/api/register/finish?username=</span><span class=si>${</span><span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>username</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 73</span><span class=cl>      <span class=nx>method</span><span class=o>:</span> <span class=s2>&#34;POST&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 74</span><span class=cl>      <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span><span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span><span class=s2>&#34;application/json&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl>      <span class=nx>body</span><span class=o>:</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>payload</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 76</span><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=ln> 77</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>res</span><span class=p>.</span><span class=nx>ok</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=kr>await</span> <span class=nx>res</span><span class=p>.</span><span class=nx>text</span><span class=p>());</span>
</span></span><span class=line><span class=ln> 78</span><span class=cl>
</span></span><span class=line><span class=ln> 79</span><span class=cl>    <span class=nx>log</span><span class=p>(</span><span class=s2>&#34;註冊完成 ✅&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 81</span><span class=cl>    <span class=nx>log</span><span class=p>(</span><span class=s2>&#34;註冊失敗：&#34;</span><span class=p>,</span> <span class=nb>String</span><span class=p>(</span><span class=nx>err</span><span class=p>));</span>
</span></span><span class=line><span class=ln> 82</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 83</span><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=ln> 84</span><span class=cl>
</span></span><span class=line><span class=ln> 85</span><span class=cl><span class=nb>document</span><span class=p>.</span><span class=nx>querySelector</span><span class=p>(</span><span class=s2>&#34;#btnLogin&#34;</span><span class=p>).</span><span class=nx>addEventListener</span><span class=p>(</span><span class=s2>&#34;click&#34;</span><span class=p>,</span> <span class=kr>async</span> <span class=p>()</span> <span class=p>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 86</span><span class=cl>  <span class=k>try</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 87</span><span class=cl>    <span class=kr>const</span> <span class=nx>username</span> <span class=o>=</span> <span class=nx>getUsername</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 88</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>username</span><span class=p>)</span> <span class=k>return</span> <span class=nx>log</span><span class=p>(</span><span class=s2>&#34;請輸入使用者名稱&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 89</span><span class=cl>
</span></span><span class=line><span class=ln> 90</span><span class=cl>    <span class=nx>log</span><span class=p>(</span><span class=s2>&#34;開始登入：&#34;</span><span class=p>,</span> <span class=nx>username</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 91</span><span class=cl>    <span class=kr>const</span> <span class=nx>requestOptions</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>postJSON</span><span class=p>(</span><span class=s2>&#34;/api/login/start&#34;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>username</span> <span class=p>});</span>
</span></span><span class=line><span class=ln> 92</span><span class=cl>    <span class=nx>decodeRequestOptions</span><span class=p>(</span><span class=nx>requestOptions</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 93</span><span class=cl>
</span></span><span class=line><span class=ln> 94</span><span class=cl>    <span class=kr>const</span> <span class=nx>assertion</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>navigator</span><span class=p>.</span><span class=nx>credentials</span><span class=p>.</span><span class=nx>get</span><span class=p>(</span><span class=nx>requestOptions</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 95</span><span class=cl>    <span class=nx>log</span><span class=p>(</span><span class=s2>&#34;assertion received&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 96</span><span class=cl>
</span></span><span class=line><span class=ln> 97</span><span class=cl>    <span class=kr>const</span> <span class=nx>payload</span> <span class=o>=</span> <span class=nx>encodeAssertionResponse</span><span class=p>(</span><span class=nx>assertion</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 98</span><span class=cl>    <span class=kr>const</span> <span class=nx>res</span> <span class=o>=</span> <span class=kr>await</span> <span class=nx>fetch</span><span class=p>(</span><span class=sb>`/api/login/finish?username=</span><span class=si>${</span><span class=nb>encodeURIComponent</span><span class=p>(</span><span class=nx>username</span><span class=p>)</span><span class=si>}</span><span class=sb>`</span><span class=p>,</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 99</span><span class=cl>      <span class=nx>method</span><span class=o>:</span> <span class=s2>&#34;POST&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>100</span><span class=cl>      <span class=nx>headers</span><span class=o>:</span> <span class=p>{</span><span class=s2>&#34;Content-Type&#34;</span><span class=o>:</span><span class=s2>&#34;application/json&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln>101</span><span class=cl>      <span class=nx>body</span><span class=o>:</span> <span class=nx>JSON</span><span class=p>.</span><span class=nx>stringify</span><span class=p>(</span><span class=nx>payload</span><span class=p>),</span>
</span></span><span class=line><span class=ln>102</span><span class=cl>    <span class=p>});</span>
</span></span><span class=line><span class=ln>103</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nx>res</span><span class=p>.</span><span class=nx>ok</span><span class=p>)</span> <span class=k>throw</span> <span class=k>new</span> <span class=nb>Error</span><span class=p>(</span><span class=kr>await</span> <span class=nx>res</span><span class=p>.</span><span class=nx>text</span><span class=p>());</span>
</span></span><span class=line><span class=ln>104</span><span class=cl>
</span></span><span class=line><span class=ln>105</span><span class=cl>    <span class=nx>log</span><span class=p>(</span><span class=s2>&#34;登入成功 🎉&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>106</span><span class=cl>  <span class=p>}</span> <span class=k>catch</span> <span class=p>(</span><span class=nx>err</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>107</span><span class=cl>    <span class=nx>log</span><span class=p>(</span><span class=s2>&#34;登入失敗：&#34;</span><span class=p>,</span> <span class=nb>String</span><span class=p>(</span><span class=nx>err</span><span class=p>));</span>
</span></span><span class=line><span class=ln>108</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>109</span><span class=cl><span class=p>});</span>
</span></span></code></pre></div><hr><h2 id=跑起來>跑起來</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl><span class=c1># 建立專案</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>mkdir passkey-mvp <span class=o>&amp;&amp;</span> <span class=nb>cd</span> passkey-mvp
</span></span><span class=line><span class=ln> 3</span><span class=cl>go mod init passkey-mvp
</span></span><span class=line><span class=ln> 4</span><span class=cl>go get github.com/go-webauthn/webauthn/webauthn github.com/go-webauthn/webauthn/protocol
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1># 建立目錄與檔案</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>mkdir public
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1># 將上面的 main.go 放在專案根目錄</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=c1># 將 index.html / style.css / utils.js / web.js 放在 ./public</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=c1># ├── go.mod</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=c1># ├── go.sum</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=c1># ├── main.go</span>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1># └── public</span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=c1>#     ├── index.html</span>
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=c1>#     ├── style.css</span>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=c1>#     ├── utils.js</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=c1>#     └── web.js</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=c1># 啟動</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>go run .
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=c1># 打開瀏覽器</span>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=c1># http://localhost:8080</span>
</span></span></code></pre></div><blockquote><p>測試流程：輸入 <code>alice</code> → 點「註冊 Passkey」→ 瀏覽器彈出系統 UI（指紋/臉）→ 成功後再點「使用 Passkey 登入」。</p></blockquote><p><strong>注意</strong>：</p><ul><li>RP ID 設為 <code>localhost</code>，Origin 是 <code>http://localhost:8080</code>。如果改成 HTTPS 或自訂網域，請同步調整 <code>webauthn.Config</code> 與前端網址。</li><li>Safari 通常需要 HTTPS；在本機開發可先用 Chrome/Edge 測試。</li></ul><hr><h2 id=常見問題mvp-版本>常見問題（MVP 版本）</h2><ol><li><p><strong>為什麼我看不到系統生物辨識 UI？</strong>
檢查：</p><ul><li>瀏覽器版本是否新；</li><li>網域/Origin 是否與後端設定一致；</li><li>作業系統是否已設定 PIN/指紋/臉部辨識。</li></ul></li><li><p><strong>多裝置同步（iCloud/Google Password Manager）怎麼處理？</strong>
這屬於使用者端的 Passkey 管理，MVP 無需特別處理。正式環境請設計「Authenticator 生命週期管理」（新增、移除、Device Bound vs Synced）。</p></li><li><p><strong>資料該存哪？</strong>
本文用 in-memory 存放。實際上要把 <code>user.Credentials</code> 存到資料庫（例如 <code>credential_id</code>, <code>public_key</code>, <code>sign_count</code> 等欄位），<code>FinishLogin</code> 後要更新 sign counter。</p></li><li><p><strong>釣魚防護靠什麼？</strong>
WebAuthn 憑證會綁定 RP ID / Origin，偽造站點無法通過驗證。仍需搭配 HTTPS、正確的 Content Security Policy 與嚴格的 cookie 設定。</p></li></ol><hr><h2 id=延伸與強化>延伸與強化</h2><ul><li><strong>註冊時的策略</strong>：Resident Key、User Verification（Required/Preferred）、Authenticator Attachment（platform/cross-platform）。</li><li><strong>後端框架化</strong>：把帳號、憑證存取抽象成 repository，改以 Postgres/SQLite。</li><li><strong>Session 安全</strong>：改為加密的 Server/DB-backed session 或使用框架（例如 gorilla/sessions）。</li><li><strong>混合登入</strong>：傳統密碼 + TOTP → 導入 Passkey，提供漸進式升級。</li><li><strong>企業整合</strong>：可延伸至 Web + 桌面/行動端（如使用 WebView/ASWebAuthenticationSession）的一致登入體驗。</li></ul><hr><h2 id=總結>總結</h2><p>本文以最小可行的方式，把 <strong>Passkey/WebAuthn</strong> 從原理整到可跑的 <strong>Go + Browser</strong> MVP。
你現在不只理解 <strong>challenge 簽章</strong> 與 <strong>公私鑰</strong> 的核心，更擁有一個能把「無密碼登入」跑起來的基本骨架。接下來，把 in-memory 換成 DB、把 session 換成安全實作、把註冊/登入流程整合到你現有的系統，就能一步步上線。</p></div><footer class=post-footer><div class=post-nav><a href=https://e61983.github.io/posts/oauth-introduction/ class=post-nav-prev><span class=nav-label>上一篇</span>
<span class=nav-title>OAuth 與授權流程詳解</span>
</a><a href=https://e61983.github.io/posts/otp-code-introduction/ class=post-nav-next><span class=nav-label>下一篇</span>
<span class=nav-title>OTP — 一次性密碼的原理與實作</span></a></div></footer></article><aside class=post-sidebar><nav class="toc desktop-toc"><h3 class=toc-title>目錄</h3><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#目標>目標</a></li><li><a href=#passkey-是什麼>Passkey 是什麼？</a></li><li><a href=#passkey-工作流程>Passkey 工作流程</a><ul><li><a href=#註冊流程registration>註冊流程（Registration）</a></li><li><a href=#登入流程authentication>登入流程（Authentication）</a></li></ul></li><li><a href=#我們要做的-mvp>我們要做的 MVP</a><ul><li><a href=#架構與流程>架構與流程</a></li></ul></li><li><a href=#後端go>後端（Go）</a></li><li><a href=#前端html--css--js>前端（HTML + CSS + JS）</a></li><li><a href=#跑起來>跑起來</a></li><li><a href=#常見問題mvp-版本>常見問題（MVP 版本）</a></li><li><a href=#延伸與強化>延伸與強化</a></li><li><a href=#總結>總結</a></li></ul></nav></nav></aside></div></div><button id=backToTop class=back-to-top aria-label=回到頂部>
<svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M7.41 15.41 12 10.83l4.59 4.58L18 14l-6-6-6 6z"/></svg></button></main><footer class=footer><div class=container><div class=footer-content><div class=social-links><a href=https://github.com/e61983 target=_blank rel=noopener class=social-link><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0C5.374.0.0 5.373.0 12c0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931.0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176.0.0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221.0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576C20.566 21.797 24 17.3 24 12c0-6.627-5.373-12-12-12z"/></svg>
GitHub</a></div><div class=copyright><p>&copy; 2025 Yuan. All rights reserved.</p><p>Powered by <a href=https://gohugo.io target=_blank rel=noopener>Hugo</a> & Yuan Theme</p></div></div></div></footer></div><script src=https://e61983.github.io/yuan/js/main.min.js></script><script async src="https://www.googletagmanager.com/gtag/js?id=G-FQ2NLS0SEB"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-FQ2NLS0SEB",{send_page_view:!0,anonymize_ip:!0,allow_google_signals:!1,allow_ad_personalization_signals:!1})</script></body></html>